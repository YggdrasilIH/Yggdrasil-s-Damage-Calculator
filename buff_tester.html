<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Battle Simulator</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f4eb; padding: 20px; }
  h1 { color: #333; }
  select, button { margin: 5px; }
  pre { background: #ddd; padding: 10px; overflow-x: auto; }
</style>
</head>
<body>

<h1>Battle Simulator</h1>

<div id="heroSelection">
  <h2>Select Heroes (Speed Order)</h2>
  <div id="heroes"></div>
  <button onclick="startSimulation()">Start Simulation</button>
</div>

<h2>Round-by-Round Timeline (LFA)</h2>
<pre id="timeline"></pre>

<script>
const heroTemplates = {
  SQH: { name:"SQH", DTThreshold:12, energy:50, transitionPoints:0, artifact:"none" },
  Ely: { name:"Ely", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" },
  LFA: { name:"LFA", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" },
  LBRM: { name:"LBRM", DTThreshold:6, energy:50, transitionPoints:0, artifact:"none" },
  BDSM: { name:"BDSM", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" },
  Vespera: { name:"Vespera", DTThreshold:6, energy:50, transitionPoints:0, artifact:"none" },
  PDE: { name:"PDE", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" }
};

const artifactOptions = ["mirror","db","scissors","antlers","none"];
const buffStats = ["atk","speed","HD","CI","ADD","critRate","critDamage","DR","armor","atkSteal"];

let battleState = { round:1, heroes:[], boss:{HD:0, atk:0, counterCount:0, abyssalCorruption:0}, timeline:[] };

// ----------------- Utility Functions -----------------
function setHeroEnergy(hero, value){ hero.energy = value; }
function tryApplyBuff(buff, hero){
  if(!hero.buffs[buff.stat]) hero.buffs[buff.stat]=[];
  hero.buffs[buff.stat].push({...buff});
}
function sumBuff(hero, stat){
  if(!hero.buffs[stat]) return 0;
  return hero.buffs[stat].reduce((a,b)=>a+b.value,0);
}
function decrementBuffs(hero){
  for(const stat in hero.buffs){
    hero.buffs[stat] = hero.buffs[stat].filter(b=>{
      if(b.duration>1){ b.duration--; return true; }
      return false;
    });
  }
}

// ----------------- Hero Actions -----------------
function applyHeroAction(hero){
  const isActive = hero.energy >= 100;

  // Consume energy if active
  if(isActive) hero.energy=0;

  // Hero-specific actions
  switch(hero.name){
    case "LFA":
      if(isActive) tryApplyBuff({stat:"atkSteal", value:0.3, duration:15}, hero);
      break;
    case "LBRM":
      tryApplyBuff({stat:"ADD", value:0.12, duration:4}, hero);
      if(hero.transitionPoints>=6){ 
        hero.transitionPoints=0; 
        tryApplyBuff({stat:"HD", value:0.1, duration:2}, hero);
        tryApplyBuff({stat:"ADD", value:0.15, duration:2}, hero);
        tryApplyBuff({stat:"ADD", value:0.1, duration:3}, hero);
      }
      break;
    case "Vespera":
      if(!isActive){
        tryApplyBuff({stat:"atk", value:0.1, duration:2}, hero);
        if(Math.random()<0.8) tryApplyBuff({stat:"ADD", value:0.08, duration:2}, hero);
      } else {
        battleState.heroes.forEach(h=>{
          tryApplyBuff({stat:"atk", value:0.1, duration:2}, h);
          tryApplyBuff({stat:"armor", value:0.1, duration:2}, h);
          tryApplyBuff({stat:"DR", value:0.1, duration:2}, h);
          tryApplyBuff({stat:"CI", value:0.1, duration:2}, h);
          tryApplyBuff({stat:"speed", value:30, duration:2}, h);
        });
      }
      break;
  }

  // Add +3% ADD to all allies for any active skill
  if(isActive) battleState.heroes.forEach(h=>tryApplyBuff({stat:"ADD", value:0.03, duration:1}, h));

  // Apply hero-specific crit buffs after active
  if(isActive){
    tryApplyBuff({stat:"critRate", value:0.5, duration:2}, hero);
    tryApplyBuff({stat:"critDamage", value:1.0, duration:2}, hero);
  }

  // Basic attack buffs
  if(!isActive){
    tryApplyBuff({stat:"ADD", value:0.35, duration:15}, hero);
    hero.energy += 100; // energy gain from basic
  }

  // Artifact energy gains
  if(hero.artifact==="db") hero.energy += 50;
  if(hero.artifact==="mirror") hero.energy += 75;

  if(hero.transitionPoints!==undefined && isActive) hero.transitionPoints += 6;
}

// ----------------- Boss -----------------
function bossCounterattack(hero){
  if(battleState.boss.counterCount>=6) return;
  battleState.boss.counterCount++;
  // 50% chance to apply Curse of Decay stack to LFA
  if(Math.random()<0.5){
    const lfa = battleState.heroes.find(h=>h.name==="LFA");
    lfa.curseStacks++;
  }
}
function applySEBossNormalAttack(){
  battleState.heroes.forEach(h=>{
    // PDE reaction to boss attack
    if(h.name==="PDE"){
      if(h.transitionPoints>=18) h.transitionPoints-=18;
      if(h.transitionPoints>=6) battleState.heroes.forEach(a=>tryApplyBuff({stat:"ADD", value:0.2, duration:3}, a));
      if(h.transitionPoints>=3){
        battleState.heroes.forEach(a=>tryApplyBuff({stat:"HD", value:0.1, duration:2}, a));
        const lfa = battleState.heroes.find(x=>x.name==="LFA");
        tryApplyBuff({stat:"ADD", value:0.15, duration:2}, lfa);
      }
    }
    tryApplyBuff({stat:"CI", value:0.15, duration:3}, h);
    tryApplyBuff({stat:"DR", value:0.1, duration:1}, h);
  });
}
function applyBossEndOfRoundEffects(){
  const lfa = battleState.heroes.find(h=>h.name==="LFA");
  if(!lfa) return;
  // Apply 8% atk steal
  tryApplyBuff({stat:"atkSteal", value:0.08, duration:2}, lfa);
  // Add curse stacks
  lfa.curseStacks += 3;
  // Drain 100 energy from LFA
  lfa.energy -= 100;
  // Reduce LFA atk by 35%
  tryApplyBuff({stat:"atk", value:-0.35, duration:1}, lfa);
  // 25% chance to remove one random buff
  if(Math.random()<0.25){
    const stats = Object.keys(lfa.buffs);
    if(stats.length>0){
      const stat = stats[Math.floor(Math.random()*stats.length)];
      lfa.buffs[stat].pop();
      if(lfa.buffs[stat].length===0) delete lfa.buffs[stat];
    }
  }
}

// ----------------- Island -----------------
function applyIslandStartRound(){
  battleState.heroes.forEach(h=>{
    tryApplyBuff({stat:"ADD", value:0.25, duration:2}, h);
    tryApplyBuff({stat:"atk", value:0.35, duration:2}, h);
    tryApplyBuff({stat:"HD", value:0.10, duration:15}, h);
  });
}
function applyIslandEndRound(){
  battleState.heroes.forEach(h=>h.energy+=50);
}

// ----------------- Round Logging -----------------
function logRound(){
  const lfa = battleState.heroes.find(h=>h.name==="LFA");
  const buffsText = buffStats.map(stat=>`${stat}=${(lfa?sumBuff(lfa, stat)*100:0).toFixed(0)}%`).join(", ");
  battleState.timeline.push({
    round:battleState.round,
    AbyssalCorruption:battleState.boss.abyssalCorruption,
    lfaEnergy:lfa?lfa.energy:0,
    lfaBuffsText:buffsText
  });
}
function renderTimeline(){
  const pre = document.getElementById("timeline");
  pre.textContent = battleState.timeline.map(r=>`R${r.round}\nAbyssal Corruption: ${r.AbyssalCorruption}\nLFA Energy: ${r.lfaEnergy}\nLFA Buffs: ${r.lfaBuffsText}`).join("\n\n");
}

// ----------------- Simulation -----------------
function startSimulation(){
  battleState.heroes=[];
  battleState.timeline=[];
  const heroSelects=document.querySelectorAll(".heroSelect");
  const artifactSelects=document.querySelectorAll(".artifactSelect");
  for(let i=0;i<6;i++){
    const name=heroSelects[i].value;
    if(!name) continue;
    const h={...heroTemplates[name], artifact:artifactSelects[i].value, buffs:{}, curseStacks:0};
    battleState.heroes.push(h);
  }

  for(battleState.round=1;battleState.round<=15;battleState.round++){
    applyIslandStartRound();
    // Heroes act in speed order
    battleState.heroes.forEach(h=>applyHeroAction(h));
    // Boss normal attacks (after all hero actions)
    applySEBossNormalAttack();
    // End of round effects
    applyIslandEndRound();
    applyBossEndOfRoundEffects();
    // Decrement buff durations
    battleState.heroes.forEach(h=>decrementBuffs(h));
    logRound();
  }

  renderTimeline();
}

// ----------------- Hero Selection UI -----------------
const heroesDiv=document.getElementById("heroes");
for(let i=0;i<6;i++){
  const div=document.createElement("div");
  div.innerHTML=`Hero:
    <select class="heroSelect">
      ${Object.keys(heroTemplates).map((h,index)=>`<option value="${h}" ${index===0?'selected':''}>${h}</option>`).join("")}
    </select>
    Artifact:
    <select class="artifactSelect">
      ${artifactOptions.map(a=>`<option value="${a}" ${a==='none'?'selected':''}>${a}</option>`).join("") }
    </select>`;
  heroesDiv.appendChild(div);
}
</script>
</body>
</html>
