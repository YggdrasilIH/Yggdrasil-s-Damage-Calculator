<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Battle Simulator</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f4eb; padding: 20px; }
  h1 { color: #333; }
  select, button { margin: 5px; }
  pre { background: #ddd; padding: 10px; overflow-x: auto; }
</style>
</head>
<body>

<h1>Battle Simulator</h1>

<div id="heroSelection">
  <h2>Select Heroes (Speed Order)</h2>
  <div id="heroes"></div>
  <button onclick="startSimulation()">Start Simulation</button>
</div>

<h2>Round-by-Round Timeline (LFA)</h2>
<pre id="timeline"></pre>

<script>
// -------------------- Hero & Artifact Definitions --------------------
const heroTemplates = {
  SQH: { name: "SQH", DTThreshold: 12, energy:50, transitionPoints:0, artifact:"none", buffs:{} },
  Ely: { name: "Ely", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none", buffs:{} },
  LFA: { name: "LFA", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none", buffs:{} },
  LBRM: { name: "LBRM", DTThreshold:6, energy:50, transitionPoints:0, artifact:"none", buffs:{} },
  BDSM: { name: "BDSM", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none", buffs:{} },
  Vespera: { name: "Vespera", DTThreshold:6, energy:50, transitionPoints:0, artifact:"none", buffs:{} },
  PDE: { name: "PDE", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none", buffs:{} }
};
const artifactOptions = ["mirror","db","scissors","antlers","none"];

// -------------------- Utility Functions --------------------
function tryApplyBuff(buff, heroBuffs){
  if(!heroBuffs[buff.stat]) heroBuffs[buff.stat]=[];
  heroBuffs[buff.stat].push({...buff});
}
function setHeroEnergy(hero, value){ hero.energy = Math.max(0,value); }
function tryGainEnergy(amount, hero){ hero.energy = Math.max(0, (hero.energy||0)+amount); }
function decrementBuffs(heroBuffs){
  for(const stat in heroBuffs){
    heroBuffs[stat] = heroBuffs[stat].filter(b=>{
      if(b.duration>1){ b.duration--; return true; }
      return false;
    });
    if(heroBuffs[stat].length===0) delete heroBuffs[stat];
  }
}
function formatBuffs(heroBuffs){
  const lines=[];
  for(const stat in heroBuffs){
    const total = heroBuffs[stat].reduce((a,b)=>a+b.value,0);
    const breakdown = heroBuffs[stat].map(b=>`${(b.value*100).toFixed(0)}% (${b.duration})`).join(", ");
    lines.push(`${total*100}% ${stat} (${breakdown})`);
  }
  return lines.join(", ");
}

// -------------------- Battle State --------------------
let battleState = {
  round:0,
  heroes:[],
  lfa:null,
  lfaDebuffs:{ curseOfDecay:{stacks:0} },
  boss:{ HDStacks:0, atkBuff:0, counterCount:0, abyssalCorruption:0 },
  timeline:[]
};

// -------------------- Hero Actions --------------------
function applyHeroAction(hero){
  const actionType = hero.energy>=100?"active":"basic";

  // Active skill consumes energy
  if(actionType==="active"){
    if(hero.name==="LBRM"){ setHeroEnergy(hero,0); tryGainEnergy(50,hero); }
    else setHeroEnergy(hero,0);
    // Post-active buffs
    if(hero.name==="LFA"){
      tryApplyBuff({stat:"critRate", value:0.5, duration:2, offsettable:true}, hero.buffs);
      tryApplyBuff({stat:"critDamage", value:1.0, duration:2, offsettable:true}, hero.buffs);
      tryApplyBuff({stat:"atkSteal", value:0.3, duration:15, offsettable:false}, hero.buffs);
    }
    if(hero.name==="Vespera"){
      battleState.heroes.forEach(h=>{
        tryApplyBuff({stat:"atk", value:0.1, duration:2, offsettable:true}, h.buffs);
        tryApplyBuff({stat:"armor", value:0.1, duration:2, offsettable:true}, h.buffs);
        tryApplyBuff({stat:"DR", value:0.1, duration:2, offsettable:true}, h.buffs);
        tryApplyBuff({stat:"CI", value:0.1, duration:2, offsettable:true}, h.buffs);
        tryApplyBuff({stat:"speed", value:30, duration:2, offsettable:true}, h.buffs);
      });
    }
    // TODO: SQH and LBRM DT triggers
    if(hero.transitionPoints!==undefined) hero.transitionPoints+=6;
    if(hero.DTThreshold && hero.transitionPoints>=hero.DTThreshold) hero.transitionPoints=0;
  }

  // Basic skill buffs
  if(actionType==="basic"){
    if(hero.name==="LFA") tryApplyBuff({stat:"critRate", value:0.24, duration:4, offsettable:true}, hero.buffs);
    if(hero.name==="LBRM") tryApplyBuff({stat:"ADD", value:0.12, duration:4, offsettable:false}, hero.buffs);
    if(hero.name==="Vespera"){
      tryApplyBuff({stat:"atk", value:0.1, duration:2, offsettable:true}, hero.buffs);
      if(Math.random()<0.8) tryApplyBuff({stat:"ADD", value:0.08, duration:2, offsettable:false}, hero.buffs);
    }
  }

  // Post-action energy/buffs
  if(actionType==="basic"){
    tryGainEnergy(150,hero);
    tryApplyBuff({stat:"ADD", value:0.35, duration:15, offsettable:false}, hero.buffs);
  }
  if(actionType==="active" && hero.name!=="LBRM"){
    tryApplyBuff({stat:"critRate", value:0.5, duration:2, offsettable:true}, hero.buffs);
    tryApplyBuff({stat:"critDamage", value:1.0, duration:2, offsettable:true}, hero.buffs);
  }

  seBossCounterattack(hero);
  applyArtifactOnHeroAction(hero);
}

// -------------------- Boss Functions --------------------
function seBossCounterattack(hero){
  if(battleState.boss.counterCount>=6) return;
  battleState.boss.counterCount++;
  battleState.lfaDebuffs.curseOfDecay.stacks+=2;
  tryApplyBuff({stat:"atk", value:-0.08, duration:3, offsettable:true}, battleState.lfa.buffs);
}
function applySEBossNormalAttack(){
  battleState.heroes.forEach(h=>{
    tryGainEnergy(10,h);
    tryGainEnergy(10,h);
  });
  battleState.lfaDebuffs.curseOfDecay.stacks+=2;
  tryApplyBuff({stat:"atk", value:-0.08, duration:3, offsettable:true}, battleState.lfa.buffs);
  tryApplyBuff({stat:"atkSteal", value:0.08, duration:3, offsettable:false}, battleState.lfa.buffs);

  // PDE boss-triggered skills
  const pde = battleState.heroes.find(h=>h.name==="PDE");
  if(pde){
    // normal attack buffs
    battleState.heroes.forEach(h=>{
      tryApplyBuff({stat:"CI", value:0.15, duration:3, offsettable:true}, h.buffs);
      tryApplyBuff({stat:"DR", value:0.10, duration:1, offsettable:true}, h.buffs);
    });
    // DT skills
    const tp = pde.transitionPoints;
    if(tp>=3){
      battleState.heroes.forEach(h=>tryApplyBuff({stat:"HD", value:0.10, duration:2, offsettable:true}, h.buffs));
      const lfa = battleState.heroes.find(h=>h.name==="LFA");
      if(lfa) tryApplyBuff({stat:"ADD", value:0.15, duration:2, offsettable:false}, lfa.buffs);
    }
    if(tp>=6){
      battleState.heroes.forEach(h=>tryApplyBuff({stat:"ADD", value:0.20, duration:3, offsettable:false}, h.buffs));
    }
    if(tp>=18) pde.transitionPoints-=18;
  }
}
function bossEndOfRound(){
  battleState.boss.HDStacks+=0.24;
  battleState.boss.atkBuff+=0.15;
  battleState.lfaDebuffs.curseOfDecay.stacks+=3;
  if(Math.random()<0.25 && Object.keys(battleState.lfa.buffs).length>0){
    const stats = Object.keys(battleState.lfa.buffs);
    delete battleState.lfa.buffs[stats[Math.floor(Math.random()*stats.length)]];
  }
  setHeroEnergy(battleState.lfa,battleState.lfa.energy-100);
  tryApplyBuff({stat:"atk", value:-0.35, duration:1, offsettable:true}, battleState.lfa.buffs);
}

// -------------------- Island Buffs --------------------
function applyIslandStartRound(){
  battleState.heroes.forEach(h=>{
    tryApplyBuff({stat:"ADD", value:0.25, duration:2, offsettable:true}, h.buffs);
    tryApplyBuff({stat:"atk", value:0.35, duration:2, offsettable:true}, h.buffs);
    tryApplyBuff({stat:"HD", value:0.10, duration:15, offsettable:true}, h.buffs);
  });
}
function applyIslandEndRound(){
  battleState.heroes.forEach(h=>tryGainEnergy(50,h));
}

// -------------------- Artifact Functions --------------------
function applyArtifactOnHeroAction(hero){
  if(hero.artifact==="db"){
    tryGainEnergy(20,hero);
    if(Math.random()<0.5) tryGainEnergy(10,hero);
  }
  if(hero.artifact==="mirror" && battleState.round===1) tryGainEnergy(75,hero);
  if(hero.artifact==="db" && battleState.round===1) tryGainEnergy(50,hero);
  if(hero.artifact==="antlers") tryApplyBuff({stat:"ADD", value:0.09, duration:15, offsettable:false}, hero.buffs);
}

// -------------------- Timeline --------------------
function logRound(){
  battleState.timeline.push({
    round:battleState.round,
    abyssalCorruption:battleState.boss.abyssalCorruption,
    lfaBuffs:JSON.parse(JSON.stringify(battleState.lfa.buffs)),
    curseStacks:battleState.lfaDebuffs.curseOfDecay.stacks,
    bossHD:battleState.boss.HDStacks,
    bossATK:battleState.boss.atkBuff,
    lfaEnergy:battleState.lfa.energy
  });
}
function renderTimeline(){
  const pre=document.getElementById("timeline");
  pre.textContent=battleState.timeline.map(r=>{
    return `R${r.round}\nAbyssal Corruption: ${r.abyssalCorruption}\nLFA Energy: ${r.lfaEnergy}\nCurse: ${r.curseStacks}\nBoss HD: ${r.bossHD.toFixed(2)}\nBoss ATK: ${(r.bossATK*100).toFixed(1)}%\nLFA Buffs: ${formatBuffs(r.lfaBuffs)||"none"}`;
  }).join("\n\n");
}

// -------------------- Simulation --------------------
function startSimulation(){
  battleState.round=0;
  battleState.timeline=[];
  battleState.heroes=[];
  const heroSelects=document.querySelectorAll(".heroSelect");
  const artifactSelects=document.querySelectorAll(".artifactSelect");
  for(let i=0;i<6;i++){
    const heroName=heroSelects[i].value;
    const artifact=artifactSelects[i].value;
    if(!heroName) continue;
    const h = {...heroTemplates[heroName], artifact, buffs:{}};
    battleState.heroes.push(h);
  }
  battleState.lfa=battleState.heroes.find(h=>h.name==="LFA");

  // Apply round 1 artifact starting energy
  battleState.heroes.forEach(h=>{
    if(h.artifact==="db") tryGainEnergy(50,h);
    if(h.artifact==="mirror") tryGainEnergy(75,h);
  });

  for(battleState.round=1;battleState.round<=15;battleState.round++){
    applyIslandStartRound();
    battleState.heroes.forEach(h=>applyHeroAction(h));
    applySEBossNormalAttack();
    bossEndOfRound();
    applyIslandEndRound();
    battleState.heroes.forEach(h=>decrementBuffs(h.buffs));
    logRound();
  }
  renderTimeline();
}

// -------------------- Hero Selection UI --------------------
const heroesDiv=document.getElementById("heroes");
for(let i=0;i<6;i++){
  const div=document.createElement("div");
  div.innerHTML=`Hero:
    <select class="heroSelect">
      ${Object.keys(heroTemplates).map(h=>`<option value="${h}">${h}</option>`).join("")}
    </select>
    Artifact:
    <select class="artifactSelect">
      ${artifactOptions.map(a=>`<option value="${a}">${a}</option>`).join("")}
    </select>`;
  heroesDiv.appendChild(div);
}
</script>
</body>
</html>
