<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Battle Simulator</title>
<style>
  body { font-family: Arial, sans-serif; background: #f5f4eb; padding: 20px; }
  h1 { color: #333; }
  select, button { margin: 5px; }
  pre { background: #ddd; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>Battle Simulator</h1>

<div id="heroSelection">
  <h2>Select Heroes (Speed Order)</h2>
  <div id="heroes"></div>
  <button onclick="startSimulation()">Start Simulation</button>
</div>

<h2>Round-by-Round Timeline (LFA)</h2>
<pre id="timeline"></pre>

<script>
// -------------------- Hero & Artifact Definitions --------------------
const heroTemplates = {
  SQH: { name: "SQH", DTThreshold: 12, energy:50, transitionPoints:0, artifact:"none" },
  Ely: { name: "Ely", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" },
  LFA: { name: "LFA", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" },
  LBRM: { name: "LBRM", DTThreshold:6, energy:50, transitionPoints:0, artifact:"none" },
  BDSM: { name: "BDSM", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" },
  Vespera: { name: "Vespera", DTThreshold:6, energy:50, transitionPoints:0, artifact:"none" },
  PDE: { name: "PDE", DTThreshold:null, energy:50, transitionPoints:0, artifact:"none" }
};
const artifactOptions = ["mirror","db","scissors","antlers","none"];
const buffStats = ["atk","speed","HD","CI","ADD","critRate","critDamage","DR","armor"];

// -------------------- Utility Functions --------------------
function setHeroEnergy(hero, value){
  hero.energy = Math.max(0,value);
}
function tryApplyBuff(buff, hero){
  if(hero.name==="LFA"){
    if(hero.curseStacks>0 && buff.offsettable){
      hero.curseStacks--;
      hero.heroLog.push(`Buff ${buff.stat} +${(buff.value*100).toFixed(1)}% offset by Curse`);
      return;
    }
    if(!hero.buffs[buff.stat]) hero.buffs[buff.stat]=[];
    hero.buffs[buff.stat].push({...buff});
    hero.heroLog.push(`Buff ${buff.stat} +${(buff.value*100).toFixed(1)}% (${buff.duration}) applied`);
  } else {
    if(buff.offsettable && hero.curseStacks>0) hero.curseStacks--;
    if(!hero.buffs[buff.stat]) hero.buffs[buff.stat]=[];
    hero.buffs[buff.stat].push({...buff});
  }
}
function tryGainEnergy(amount, hero){
  if(hero.name==="LFA"){
    if(hero.curseStacks>0){
      hero.curseStacks--;
      hero.heroLog.push(`Energy +${amount} offset by Curse`);
      return; 
    }
    hero.energy += amount;
    hero.heroLog.push(`Energy +${amount}`);
  } else {
    if(hero.curseStacks>0 && amount>0) hero.curseStacks--;
    hero.energy += amount;
  }
}
function getTotalBuff(hero, stat){
  if(!hero.buffs[stat]) return 0;
  return hero.buffs[stat].reduce((sum,b)=>sum+b.value,0);
}
function decrementBuffs(hero){
  for(const stat in hero.buffs){
    hero.buffs[stat] = hero.buffs[stat].filter(b=>{
      if(b.duration>1){ b.duration--; return true; }
      return false;
    });
    if(hero.buffs[stat].length===0) delete hero.buffs[stat];
  }
}

// -------------------- Battle State --------------------
let battleState = {
  round:1,
  heroes:[],
  boss:{ HD:0, atk:0, counterCount:0, abyssalCorruption:0 },
  timeline: []
};

// -------------------- Hero Actions --------------------
function applyHeroAction(hero){
  const actionType = hero.energy>=100 ? "active" : "basic";

  // Active skill
  if(actionType==="active"){
    setHeroEnergy(hero,0);
    // All allies gain 3% ADD
    battleState.heroes.forEach(h=>{
      tryApplyBuff({stat:"ADD", value:0.03, duration:1, offsettable:true}, h);
    });
  }

  // Hero-specific actions
  switch(hero.name){
    case "LFA":
      if(actionType==="active"){
        tryApplyBuff({stat:"atkSteal", value:0.3, duration:15, offsettable:false}, hero);
      }
      break;
    case "LBRM":
      tryApplyBuff({stat:"ADD", value:0.12, duration:4, offsettable:false}, hero);
      if(hero.transitionPoints>=6){
        hero.transitionPoints=0;
        tryApplyBuff({stat:"HD", value:0.1, duration:2, offsettable:true}, hero);
        tryApplyBuff({stat:"ADD", value:0.15, duration:2, offsettable:false}, hero);
        tryApplyBuff({stat:"ADD", value:0.1, duration:3, offsettable:false}, hero);
      }
      break;
    case "Vespera":
      if(actionType==="basic"){
        tryApplyBuff({stat:"atk", value:0.1, duration:2, offsettable:true}, hero);
        if(Math.random()<0.8) tryApplyBuff({stat:"ADD", value:0.08, duration:2, offsettable:false}, hero);
      }
      if(actionType==="active"){
        battleState.heroes.forEach(h=>{
          tryApplyBuff({stat:"atk", value:0.1, duration:2, offsettable:true}, h);
          tryApplyBuff({stat:"armor", value:0.1, duration:2, offsettable:true}, h);
          tryApplyBuff({stat:"DR", value:0.1, duration:2, offsettable:true}, h);
          tryApplyBuff({stat:"CI", value:0.1, duration:2, offsettable:true}, h);
          tryApplyBuff({stat:"speed", value:30, duration:2, offsettable:true}, h);
        });
      }
      break;
  }

  // Post-action buffs
  if(actionType==="basic"){
    tryApplyBuff({stat:"ADD", value:0.35, duration:15, offsettable:false}, hero);
    tryGainEnergy(100, hero);
  }
  if(actionType==="active"){
    tryApplyBuff({stat:"critRate", value:0.5, duration:2, offsettable:true}, hero);
    tryApplyBuff({stat:"critDamage", value:1.0, duration:2, offsettable:true}, hero);
    // Artifacts
    if(hero.artifact==="db") tryGainEnergy(50, hero);
    if(hero.artifact==="mirror") tryGainEnergy(75, hero);
  }

  if(hero.transitionPoints!==undefined && actionType==="active") hero.transitionPoints+=6;

  // Boss counter after hero active
  if(actionType==="active") seBossCounterattack();
}

// -------------------- Boss Functions --------------------
function seBossCounterattack(){
  if(battleState.boss.counterCount>=6) return;
  battleState.boss.counterCount++;
  const lfa = battleState.heroes.find(h=>h.name==="LFA");
  if(!lfa) return;
  if(Math.random()<0.5){
    lfa.curseStacks++;
    lfa.heroLog.push("Boss counter adds 1 layer of Curse");
  }
}

function applySEBossNormalAttack(){
  const lfa = battleState.heroes.find(h=>h.name==="LFA");
  battleState.heroes.forEach(h=>{
    // PDE reactions
    if(h.name==="PDE"){
      if(h.transitionPoints>=18) h.transitionPoints-=18;
      if(h.transitionPoints>=6){
        battleState.heroes.forEach(a=>tryApplyBuff({stat:"ADD", value:0.2, duration:3, offsettable:false}, a));
      }
      if(h.transitionPoints>=3){
        battleState.heroes.forEach(a=>tryApplyBuff({stat:"HD", value:0.1, duration:2, offsettable:true}, a));
        if(lfa) tryApplyBuff({stat:"ADD", value:0.15, duration:2, offsettable:false}, lfa);
      }
    }
    // CI and DR
    tryApplyBuff({stat:"CI", value:0.15, duration:3, offsettable:true}, h);
    tryApplyBuff({stat:"DR", value:0.1, duration:1, offsettable:true}, h);
  });

  // LFA loses 100 energy at end of boss turn
  if(lfa) setHeroEnergy(lfa, lfa.energy-100);
  if(lfa) lfa.heroLog.push("Boss steals 100 energy");

  // Boss attack steal or curse effects
  if(lfa){
    tryApplyBuff({stat:"atk", value:-0.08, duration:2, offsettable:true}, lfa);
    lfa.heroLog.push("Boss reduces LFA attack by 8%");
    if(Math.random()<0.5){
      lfa.curseStacks += 2;
      lfa.heroLog.push("Boss adds 2 layers of Curse of Decay");
    }
  }

  // Scissors artifact copies buffs to LFA
  if(battleState.heroes.some(h=>h.artifact==="scissors")){
    battleState.heroes.forEach(h=>{
      for(const stat in h.buffs){
        h.buffs[stat].forEach(b=>{
          if(!lfa.buffs[stat]) lfa.buffs[stat]=[];
          lfa.buffs[stat].push({...b});
          lfa.heroLog.push(`Scissors copied ${stat} +${(b.value*100).toFixed(1)}% (${b.duration})`);
        });
      }
    });
  }
}

// -------------------- Island Buffs --------------------
function applyIslandStartRound(){
  battleState.heroes.forEach(h=>{
    tryApplyBuff({stat:"ADD", value:0.25, duration:2, offsettable:true}, h);
    tryApplyBuff({stat:"atk", value:0.35, duration:2, offsettable:true}, h);
    tryApplyBuff({stat:"HD", value:0.10, duration:15, offsettable:true}, h);
  });
}
function applyIslandEndRound(){
  battleState.heroes.forEach(h=>{
    tryGainEnergy(50, h);
  });
}

// -------------------- Timeline --------------------
function logRound(){
  const lfa = battleState.heroes.find(h=>h.name==="LFA");
  const buffsText = buffStats.map(stat=>`${stat}: ${(getTotalBuff(lfa,stat)*100).toFixed(1)}%`).join(", ");
  battleState.timeline.push({
    round: battleState.round,
    AbyssalCorruption: battleState.boss.abyssalCorruption,
    lfaEnergy: lfa.energy,
    lfaBuffsText: buffsText,
    lfaEvents: lfa.heroLog.slice()
  });
}
function renderTimeline(){
  const pre = document.getElementById("timeline");
  pre.textContent = battleState.timeline.map(r=>{
    const events = r.lfaEvents.join("; ");
    return `R${r.round}\nAbyssal Corruption: ${r.AbyssalCorruption}\nLFA Energy: ${r.lfaEnergy}\nLFA Buffs: ${r.lfaBuffsText}\nEvents: ${events}`;
  }).join("\n\n");
}

// -------------------- Simulation --------------------
function startSimulation(){
  battleState.heroes=[];
  battleState.timeline=[];
  const heroSelects = document.querySelectorAll(".heroSelect");
  const artifactSelects = document.querySelectorAll(".artifactSelect");
  for(let i=0;i<6;i++){
    const heroName = heroSelects[i].value;
    if(!heroName) continue;
    const h = {...heroTemplates[heroName], artifact:artifactSelects[i].value};
    h.buffs={};
    h.curseStacks=0;
    if(h.name==="LFA") h.heroLog=[];
    battleState.heroes.push(h);
  }

  for(battleState.round=1;battleState.round<=15;battleState.round++){
    battleState.boss.counterCount=0;
    battleState.heroes.forEach(h=>{
      if(h.name==="LFA") h.heroLog=[];
    });
    applyIslandStartRound();
    battleState.heroes.forEach(h=>applyHeroAction(h));
    applySEBossNormalAttack();
    applyIslandEndRound();
    battleState.heroes.forEach(h=>{
      if(h.artifact==="antlers") tryApplyBuff({stat:"ADD", value:0.09, duration:15, offsettable:false}, h);
      decrementBuffs(h);
    });
    logRound();
  }
  renderTimeline();
}

// -------------------- Hero Selection UI --------------------
const heroesDiv=document.getElementById("heroes");
for(let i=0;i<6;i++){
  const div=document.createElement("div");
  div.innerHTML=`Hero:
    <select class="heroSelect">
      ${Object.keys(heroTemplates).map((h,index)=>`<option value="${h}" ${index===0?'selected':''}>${h}</option>`).join("")}
    </select>
    Artifact:
    <select class="artifactSelect">
      ${artifactOptions.map(a=>`<option value="${a}" ${a==='none'?'selected':''}>${a}</option>`).join("") }
    </select>`;
  heroesDiv.appendChild(div);
}
</script>
</body>
</html>
