<!DOCTYPE html>
<html>
<head>
    <title>Idle Hero Logic Simulator - Scissors & LBRM Fixed</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f1a; color: #e0e0e0; padding: 20px; font-size: 14px; }
        .setup { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #161b33; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #2f3542; }
        .hero-box { border: 1px solid #474787; padding: 10px; border-radius: 4px; background: #1a1a2e; }
        .log { background: #000; border: 2px solid #474787; padding: 15px; height: 600px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; color: #f1f2f6; line-height: 1.5; margin-bottom: 20px;}
        .summary-card { background: #161b33; padding: 20px; border-radius: 8px; border: 2px solid #2ed573; margin-top: 20px; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .summary-table th, .summary-table td { padding: 10px; border: 1px solid #2f3542; text-align: left; }
        .summary-table th { background: #2f3542; color: #2ed573; }
        .round-head { color: #ff4757; border-bottom: 2px solid #ff4757; margin-top: 25px; font-weight: bold; font-size: 1.3em; background: #2d142c; padding: 5px; }
        .phase-name { color: #eccc68; margin-top: 15px; font-weight: bold; text-transform: uppercase; border-left: 4px solid #eccc68; padding-left: 10px; background: #222; }
        .nrg-badge { background: #1e90ff; color: white; padding: 1px 4px; border-radius: 3px; font-weight: bold; }
        .curse-badge { background: #747d8c; color: #ffa502; padding: 1px 4px; border-radius: 3px; font-weight: bold; border: 1px solid #ffa502; }
        .curse-offset { color: #ff7f50; font-style: italic; }
        select, button, input { padding: 5px; border-radius: 4px; border: 1px solid #57606f; background: #2f3542; color: white; width: 100%; margin-top: 2px; box-sizing: border-box; }
        button { background: #ff4757; font-weight: bold; cursor: pointer; border: none; font-size: 1.1em; margin-top: 10px;}
        input[type="number"] { width: 60px; display: inline-block; }
    </style>
</head>
<body>

    <div class="setup" id="heroSetup"></div>
    <button onclick="simulate()">Simulate 15-Round Battle</button>
    
    <div id="log" class="log"></div>
    <div id="summary" class="summary-card" style="display:none;"></div>

<script>
const HERO_LIST = ["LFA", "SQH", "STV", "BDSM", "FQV", "LBRM", "ELY", "HW"];
const ARTIFACTS = ["None", "Demon Bell", "Mirror", "Antlers", "Scissors"];

const setupEl = document.getElementById('heroSetup');
for(let i=1; i<=6; i++) {
    setupEl.innerHTML += `
        <div class="hero-box">
            <strong>Pos ${i}</strong><br>
            Hero: <select id="hero${i}">${HERO_LIST.map(h => `<option value="${h}" ${i===1 && h==='LFA'?'selected':''}>${h}</option>`).join('')}</select>
            Art: <select id="art${i}">${ARTIFACTS.map(a => `<option value="${a}">${a}</option>`).join('')}</select>
            SPD: <input type="number" id="spd${i}" value="${2000 - (i*10)}">
            Dodge%: <input type="number" id="dg${i}" value="0">
            <label style="font-size:10px; color:#ff4757; display:block;"><input type="radio" name="highestAtk" value="${i}" ${i===1?'checked':''}> Highest ATK</label>
        </div>`;
}

let heroes = [];
const logEl = document.getElementById('log');
function log(msg, cls = "") { logEl.innerHTML += `<div class="${cls}">${msg}</div>`; }

function checkCurse(hero, type, amount = "") {
    if (hero.curseLayers > 0) {
        hero.curseLayers--;
        log(`&nbsp;&nbsp;&nbsp;âœ¨ Curse Offset: ${hero.name} ${type} ${amount}. (Layers: ${hero.curseLayers})`, "curse-offset");
        return false;
    }
    return true;
}

function triggerBDSMOverload(h) {
    log(`&nbsp;&nbsp;&nbsp;ðŸ›¡ï¸ BDSM Overload! Buffing Backline CI.`);
    heroes.forEach(ally => { if(!ally.isFrontLine) checkCurse(ally, "CI Buff"); });
}

function simulate() {
    logEl.innerHTML = "";
    document.getElementById('summary').style.display = "none";
    heroes = [];
    const targetPos = parseInt(document.querySelector('input[name="highestAtk"]:checked').value);
    
    for(let i=1; i<=6; i++) {
        heroes.push({
            pos: i, name: document.getElementById(`hero${i}`).value,
            energy: (document.getElementById(`art${i}`).value === "Demon Bell" || document.getElementById(`art${i}`).value === "Mirror") ? 100 : 50,
            curseLayers: 0, artifact: document.getElementById(`art${i}`).value,
            transition: 0, spd: parseInt(document.getElementById(`spd${i}`).value),
            dodge: parseInt(document.getElementById(`dg${i}`).value),
            isHighestAtk: (i === targetPos), isFrontLine: i <= 2,
            activeCount: 0
        });
    }

    for (let r = 1; r <= 15; r++) {
        log(`ROUND ${r}`, "round-head");

        // PART 1: SOR (Position Order)
        log("Part 1: Start of Round", "phase-name");
        heroes.forEach(h => {
            log(`&nbsp;&nbsp;&nbsp;âš”ï¸ P${h.pos}: ${h.name} Global ATK Buff`);
            checkCurse(h, "Global ATK Buff");
            if (h.name === "STV" && h.transition >= 6) {
                log(`&nbsp;&nbsp;&nbsp;âœ¨ STV Start-of-Round Payoff!`);
                h.transition -= 6;
                heroes.forEach(ally => { if(checkCurse(ally, "Energy", "20")) ally.energy += 20; });
            }
        });

        // PART 2: Actions (Speed Order)
        log("Part 2: Attacking Phase", "phase-name");
        let speedOrder = [...heroes].sort((a, b) => (b.spd !== a.spd) ? b.spd - a.spd : a.pos - b.pos);
        speedOrder.forEach(h => {
            log(`[${h.name} P${h.pos}] <span class="nrg-badge">NRG: ${h.energy}</span> <span class="curse-badge">CURSE: ${h.curseLayers}</span>`);
            let usedActive = false;
            if (h.energy >= 100) {
                log(`ðŸ”¥ ${h.name} uses ACTIVE!`);
                h.energy = 0; usedActive = true; h.activeCount++;
                if (h.name === "LFA") { h.transition += 6; checkCurse(h, "Self ATK Buff"); }
                if (h.name === "SQH") h.transition += 6;
                if (h.name === "STV") { 
                    h.transition += 6;
                    heroes.forEach(a => { ["ATK","Armor","DR","CI","Speed"].forEach(b => checkCurse(a, b+" Buff")); });
                }
                if (h.name === "BDSM") {
                    h.transition += 6;
                    if(checkCurse(h, "Energy", "3")) { h.energy += 3; if(h.energy > 100) triggerBDSMOverload(h); }
                    if(Math.random() < 0.4) {
                        heroes.forEach(a => { if(checkCurse(a, "Energy", "10")) { a.energy += 10; if(a.name === "BDSM" && a.energy > 100) triggerBDSMOverload(a); } });
                    }
                }
                if (h.name === "FQV") { h.transition += 6; heroes.forEach(a => checkCurse(a, "Armor Buff")); }
                if (h.name === "LBRM") {
                    h.transition += 6; // Gaining 6 layers on Active
                    if(checkCurse(h, "Energy", "50")) h.energy += 50;
                    if(h.transition >= 6) { 
                        log(`&nbsp;&nbsp;&nbsp;âœ¨ LBRM Holy Damage Payoff (6 Stacks)`);
                        h.transition -= 6; 
                        heroes.forEach(a => checkCurse(a, "Holy Dmg Buff")); 
                    }
                }
            } else {
                log(`âš”ï¸ ${h.name} uses Basic Attack.`);
                if (checkCurse(h, "Energy", "50")) h.energy += 50;
                if (h.name === "LFA") checkCurse(h, "Self Crit Buff");
                if (h.name === "SQH") { checkCurse(h, "Crit Buff"); checkCurse(h, "Crit Dmg Buff"); }
                if (h.name === "STV") heroes.forEach(a => { if(a.isFrontLine){ checkCurse(a, "DR Buff"); checkCurse(a, "CI Buff"); } else { checkCurse(a, "ATK Buff"); } });
            }

            if (h.transition >= 12 && ["SQH", "BDSM", "FQV"].includes(h.name)) {
                h.transition -= 12;
                log(`&nbsp;&nbsp;&nbsp;âœ¨ ${h.name} Transition Payoff Trigger!`);
                heroes.forEach(ally => {
                    if (h.name === "SQH" && ally !== h) { checkCurse(ally, "ATK"); checkCurse(ally, "DR"); if(checkCurse(ally, "Energy", "20")) ally.energy += 20; }
                    if (h.name === "BDSM") { if(checkCurse(ally, "Energy", "20")) { ally.energy += 20; if(ally.name === "BDSM" && ally.energy > 100) triggerBDSMOverload(ally); } }
                    if (h.name === "FQV") { checkCurse(ally, "ATK"); checkCurse(ally, "Armor"); if(checkCurse(ally, "Energy", "20")) ally.energy += 20; }
                });
            }
            if (h.artifact === "Demon Bell" && usedActive) {
                heroes.forEach(a => { if(checkCurse(a, "Energy", "20")) a.energy += 20; });
            }
        });

        // BOSS ATTACK
        log("ðŸ‘¾ Boss Attacks Team", "phase-name");
        heroes.forEach(h => {
            if (Math.random() * 100 < h.dodge) log(`&nbsp;&nbsp;&nbsp;ðŸ’¨ ${h.name} DODGED!`);
            else { if (checkCurse(h, "Energy", "10")) h.energy += 10; h.curseLayers += 2; }
        });

        // PART 4: EOR (Position Order)
        log("Part 4: End of Round", "phase-name");
        heroes.forEach(h => {
            // Artifacts/Skill EOR
            if (h.artifact === "Mirror") heroes.forEach(a => { if(checkCurse(a, "Energy", "15")) a.energy += 15; });
            if (h.artifact === "Scissors") {
                log(`&nbsp;&nbsp;&nbsp;âœ‚ï¸ ${h.name} Scissors Trigger (Line: ${h.isFrontLine ? 'Front' : 'Back'})`);
                heroes.forEach(a => { 
                    if(a.isFrontLine === h.isFrontLine) { checkCurse(a, "Scissors ATK"); checkCurse(a, "Scissors Holy Dmg"); } 
                });
            }
            if (h.name === "ELY") checkCurse(heroes[Math.floor(Math.random()*6)], "Speed Buff");
            
            // Global Energy surge
            log(`&nbsp;&nbsp;&nbsp;ðŸ”‹ P${h.pos}: ${h.name} Global 50 NRG surge`);
            if(checkCurse(h, "Global Energy", "50")) h.energy += 50;
        });

        let t = heroes.find(h => h.isHighestAtk);
        log(`ðŸŽ¯ Boss Drain: ${t.name}`, "hero-msg");
        t.energy = Math.max(0, t.energy - 100); t.curseLayers += 3;
    }

    const summaryEl = document.getElementById('summary');
    summaryEl.style.display = "block";
    let tableHtml = `<h3>Battle Statistics</h3><table class="summary-table"><tr><th>Pos</th><th>Hero</th><th>Actives</th><th>Final Curse</th></tr>`;
    heroes.forEach(h => { tableHtml += `<tr><td>${h.pos}</td><td><b>${h.name}</b></td><td>${h.activeCount}</td><td>${h.curseLayers}</td></tr>`; });
    summaryEl.innerHTML = tableHtml + `</table>`;
}
</script>
</body>
</html>
