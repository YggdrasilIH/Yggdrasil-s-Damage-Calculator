<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LFA Boss Active Damage Calculator</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #f5f4eb; /* Soft off-white background */
      margin: 0;
      padding: 0;
    }
 
    .calculator {
      background: #d9c0a0; /* Even lighter brown for contrast */
      padding: 20px;
      margin: 40px auto;
      width: 760px;
      border-radius: 10px; /* More subtle rounded corners */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: white;
      background-color: #9e7d53; /* Light brown for the title */
      padding: 12px;
      border-radius: 8px;
      font-size: 24px;
      text-align: center;
      text-transform: uppercase;
    }

    .section {
      background: #c19c6c; /* Darker brown for sections */
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px; /* Subtle rounded corners */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #d2b27d; /* Lighter brown border */
      border-radius: 6px; /* Slightly less rounded */
      background: #fff;
      color: #333;
    }

    input[type="range"] {
      width: 100%;
    }

    h3 {
      color: #5c3c1b; /* Dark brown for section titles */
      font-size: 18px;
      margin-bottom: 10px;
    }

    button {
      padding: 14px 24px;
      margin-top: 20px;
      cursor: pointer;
      border-radius: 8px; /* Subtle rounded corners for the button */
      border: none;
      background: #f1c40f; /* Softer yellow */
      color: #5c3c1b; /* Dark brown text */
      font-weight: bold;
      font-size: 18px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background: #f39c12; /* Slightly darker yellow */
    }

    button:before {
      content: "⚔️"; /* Sword icon before the button text */
      margin-right: 10px;
    }

    .tabs {
      display: flex;
      justify-content: flex-start;
      gap: 0px; /* No space between tabs */
      margin-top: 20px;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      background: #c19c6c; /* Dark brown for tabs */
      border-radius: 6px 6px 0 0;
      font-size: 18px;
      font-weight: bold;
      border: 1px solid #ddd;
    }

    .tab.active {
      background: #9e7d53; /* Active tab with light brown background */
      color: white;
      border-color: #9e7d53;
    }

    .tab-content {
      background: #c19c6c; /* Darker brown background for content */
      padding: 20px;
      border-radius: 0 0 8px 8px;
      text-align: left;
      font-size: 16px;
      color: #333;
    }

    .damage-summary {
      font-size: 16px;
    }

    .damage {
      color: #333;
    }

    .damage.white {
      color: #777;
    }

    .damage.green {
      color: #9e7d53; /* Green color for special info */
    }

    .damage.purple {
      color: #ba68c8;
    }

    .artifact-section {
      display: flex;
      flex-direction: column;
      background: #c19c6c; /* Darker brown background for Elyvia and Artifacts */
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }

    .artifact-section h3 {
      color: #5c3c1b; /* Dark brown color for artifact section titles */
    }

    .artifact-labels {
      display: flex;
      flex-direction: column; /* Make bullets appear below the Elyvia checkbox */
      gap: 10px; /* Spacing between bullets */
      margin-top: 10px;
    }

    .artifact-section label {
      margin-right: 20px;
    }

    .artifact-section input {
      width: auto;
      margin-right: 10px;
    }

    .small {
      font-size: 12px;
      color: #777;
    }

    .tabs .tab.active, .tab-content {
      background: #c19c6c;
    }

  </style>
</head>
<body>
  <div class="calculator">
    <h2>LFA Damage Calculator</h2>

    <!-- Stats -->
    <div class="section">
      <h3>Stats</h3>
      <div class="grid">
        <input type="number" id="attack" placeholder="Attack">
        <input type="number" id="sd" placeholder="SD (%)">
        <input type="number" id="precision" placeholder="Precision (%) (max 150)">
        <input type="number" id="add" placeholder="ADD (%)">
        <input type="number" id="critDamage" placeholder="Crit Damage % (max 150)">
        <input type="number" id="sqh" placeholder="SQH Stacks">
        <input type="number" id="transitionPoint" placeholder="Transition Point (0 or 12)">
      </div>
    </div>

    <!-- Elyvia and Artifacts Section -->
    <div class="section artifact-section">
      <h3>Elyvia</h3>
      <label><input type="checkbox" id="elyvia"> Enable Shrink</label>
      <div class="artifact-labels">
        <h3>Artifacts</h3>
        <label><input type="radio" name="artifact" id="none" checked> None</label>
        <label><input type="radio" name="artifact" id="antiwarrior"> Antiwarrior (×1.9)</label>
        <label><input type="radio" name="artifact" id="antlers"> Antlers (+126% ADD, +300% SD)</label>
      </div>
    </div>

    <!-- Enemy HP and Crits -->
    <div class="section">
      <div class="grid">
        <div>
          <h3>Enemy HP %</h3>
          <input type="range" id="enemyHP" min="0" max="100" value="100"
            oninput="document.getElementById('enemyHPVal').innerText=this.value+'%'">
          <div id="enemyHPVal">100%</div>
        </div>
        <div>
          <h3>Crits</h3>
          <input type="number" id="crits" min="0" max="5" value="0">
          <div class="small">At HP > 60%, only first 3 hits can crit.</div>
        </div>
      </div>
    </div>

    <!-- Extra Multipliers -->
    <div class="section">
      <h3>Extra multipliers</h3>
      <div class="grid">
        <input type="number" id="hd" placeholder="HD (e.g. 200)">
        <input type="number" id="pet" placeholder="Pet % (e.g. 80)">
        <input type="number" id="dot1" placeholder="Dot Bonus 1 (%)">
        <input type="number" id="dot2" placeholder="Dot Bonus 2 (%)">
        <input type="number" id="maim" placeholder="Maim (%)">
      </div>
      <div class="small mono">
        HD multiplier = 1 + 0.7 × (HD / 100),
        Pet multiplier = 1 + (Pet% / 100),
      </div>
    </div>

    <button id="calcBtn">Calculate</button>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="summary">Summary</div>
      <div class="tab" data-tab="breakdown">Breakdown</div>
      <div class="tab" data-tab="contributions">Contributions</div>
    </div>

    <!-- Tab Contents -->
    <div id="summary" class="tab-content">Damage: --</div>
    <div id="breakdown" class="tab-content" style="display:none;">Breakdown: --</div>
    <div id="contributions" class="tab-content" style="display:none;">Contributions: --</div>
  </div>

  <div class="section">
  <h3>Optimal Crit Rate</h3>
  <div class="total-value">
    <input id="optimalCritRate" type="text" readonly />
  </div>
</div>

<script>
// --- Tab Switching ---

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const selected = tab.getAttribute('data-tab');
    document.getElementById('summary').style.display = selected === 'summary' ? 'block' : 'none';
    document.getElementById('breakdown').style.display = selected === 'breakdown' ? 'block' : 'none';
    document.getElementById('contributions').style.display = selected === 'contributions' ? 'block' : 'none';
  });
});

document.getElementById('calcBtn').addEventListener('click', calculateDamage);

function calculateDamage() {
  // --- Initialize ---
  let templeHitDamage = [];
  let subtotal = 0;
  let total = 0;
  let hasNonCrit = false;
  let additionalDamage = 0;

  // --- Inputs ---
  const attack = parseFloat(document.getElementById('attack').value) || 0;
  const sdInput = parseFloat(document.getElementById('sd').value) || 0;
  let sd = sdInput / 100;

  let precisionInput = parseFloat(document.getElementById('precision').value) || 0;
  precisionInput = Math.min(precisionInput, 150); // Cap precision at 150
  const precision = precisionInput / 100;

  const addRaw = parseFloat(document.getElementById('add').value) || 0;
  let add = 1 + addRaw / 100;

  const elyvia = document.getElementById('elyvia').checked ? 1.4 : 1;

  let cdInput = parseFloat(document.getElementById('critDamage').value) || 0;
  cdInput = Math.min(cdInput, 150); // Cap critDamage at 150
  const critDamage = cdInput / 100;

  const sqh = parseFloat(document.getElementById('sqh').value) || 0;
  const enemyHP = parseFloat(document.getElementById('enemyHP').value) || 100;
  const critsSelected = parseInt(document.getElementById('crits').value) || 0;

  const hdInput = parseFloat(document.getElementById('hd').value) || 0;
  const hdMultiplier = 1 + 0.7 * (hdInput / 100);

  const petInput = parseFloat(document.getElementById('pet').value) || 0;
  const petMultiplier = 1 + (petInput / 100);

  const dot1 = (parseFloat(document.getElementById('dot1').value) / 100) || 0;
  const dot2 = (parseFloat(document.getElementById('dot2').value) / 100) || 0;

  const maimInput = parseFloat(document.getElementById('maim').value) || 0;
  const maimMultiplier = 1 + (1 - enemyHP / 100) * (maimInput / 100);

  // --- Artifact Multipliers ---
  const ARTIFACT_NONE = 1;
  const ARTIFACT_ANTI_WARRIOR = 1.9;
  const ANTLERS_ADD_BONUS = 1.26;
  const ANTLERS_SD_BONUS = 3.0;

  let artifactMultiplier = ARTIFACT_NONE;
  let addExtra = 0;
  let sdExtra = 0;
  if (document.getElementById('antiwarrior').checked) {
    artifactMultiplier = ARTIFACT_ANTI_WARRIOR;
  } else if (document.getElementById('antlers').checked) {
    addExtra = ANTLERS_ADD_BONUS;
    sdExtra = ANTLERS_SD_BONUS;
  }

  // --- Base Damage ---
  const baseDamage = attack * (12 + sd + sdExtra) * (1 + 0.3 * precision) * (add + addExtra) * maimMultiplier * elyvia * hdMultiplier * petMultiplier;

  const defier = enemyHP > 70 ? 1.3 : 1;
  const giantKiller = 2;

  // Determine the number of LFA hits based on the enemy HP
  const hits = enemyHP > 60 ? 3 : 5; // 3 hits for HP > 60%, 5 hits for HP <= 60%

  const critBase = 1.5 + 2 * critDamage;
  const critMultiplier = sqh > 0 ? critBase * (1 + 0.24 * sqh) : critBase;

  // --- LFA Hits ---
  for (let i = 1; i <= hits; i++) {
    let isCrit = false;
    if (critsSelected > 0) {
      isCrit = enemyHP > 60 ? i <= Math.min(critsSelected, 3) : i <= Math.min(critsSelected, 5);
    }
    if (!isCrit) hasNonCrit = true;

    const damagePerHit = baseDamage * (1 + dot1) * (1 + dot2) * (isCrit ? critMultiplier : 1) * defier * giantKiller * artifactMultiplier;
    const totalHitDamage = damagePerHit * 2.5;

    templeHitDamage.push(totalHitDamage);
    subtotal += totalHitDamage;
  }

  // --- Demon King's Might Calculation ---
  let sumTempleHitDamage = 0;
  const maxHitsForDKM = enemyHP > 60 ? 2 : 4; // Limit DKM to the first 2 or 4 hits

  for (let i = 0; i < maxHitsForDKM; i++) {
    sumTempleHitDamage += templeHitDamage[i];
  }

  const demonKingsMightTemple = sumTempleHitDamage * (add + addExtra) * defier * maimMultiplier * elyvia * 1.2 * 2.5;
  subtotal += demonKingsMightTemple;

  let balancedStrike = 0;
  let bsProc = false;
  let bsMultiplier = enemyHP <= 50 ? 1.95 : 0.45;

  if (hasNonCrit) {
    bsProc = true;
    balancedStrike = subtotal * bsMultiplier * defier * elyvia * (add + addExtra) * maimMultiplier * giantKiller * 2.5;
  }

  let lfbMultiplier = 1.0;
  if (bsProc) lfbMultiplier += bsMultiplier;

  const lethalFightback = subtotal * 0.18 * defier * giantKiller * (add + addExtra) * maimMultiplier * elyvia * lfbMultiplier * 2.5;

  // --- Transition Point ---
  const transitionPoint = parseInt(document.getElementById('transitionPoint').value) || 0;

  if (transitionPoint === 12) {
    const isBelow50HP = enemyHP < 50;

    // Base multipliers that apply to each hit
    const baseMultiplier = giantKiller * defier * elyvia * (1 + 0.3 * precision) * hdMultiplier * petMultiplier * (1 + dot1) * (1 + dot2) * (add + addExtra) * maimMultiplier * artifactMultiplier * 2.5;

    // First hit: 1500% × Attack, applied 2 times
    let hit1 = 1500 * attack * 2;
    hit1 *= baseMultiplier;

    // Second hit: 1000% × Attack
    let hit2 = 1000 * attack;
    hit2 *= baseMultiplier;

    // Third hit: 800% or 1200% based on enemy HP
    let hit3 = (isBelow50HP ? 800 : 1200) * attack;
    hit3 *= baseMultiplier;

    // Sum all transition damage hits
    additionalDamage = hit1 + hit2 + hit3;
  }


  total = subtotal + balancedStrike + lethalFightback + additionalDamage; // Add the transition bonus

// After LFA Hits, Demon King's Might, Balanced Strike, Lethal Fightback, etc. calculation
// --- Optimal Crit Rate Calculation ---
// Move this block to the end of your damage calculation function
let maxExpectedValue = 0;
let optimalCrits = 0;

// Loop through possible crits (0 to 5)
for (let i = 0; i <= 5; i++) {
  let expectedDamage = 0;
  let totalHitDamage = 0;
  let templeHitDamageTemp = []; // Temp array for hits in this loop

  // Calculate expected damage for i crits
  for (let j = 0; j < hits; j++) {
    let critProbability = i / hits; // Probability of this hit being a crit
    let nonCritProbability = 1 - critProbability;

    // Expected damage for this hit considering crit and non-crit probabilities
    const expectedDamagePerHit = (critProbability * baseDamage * (1 + dot1) * (1 + dot2) * critMultiplier * defier * giantKiller * artifactMultiplier) +
                                 (nonCritProbability * baseDamage * (1 + dot1) * (1 + dot2) * defier * giantKiller * artifactMultiplier);

    totalHitDamage = expectedDamagePerHit * 2.5; // Apply Temple multiplier
    templeHitDamageTemp.push(totalHitDamage);
    expectedDamage += totalHitDamage;
  }

  // Calculate expected Demon King's Might (DKM)
  let sumTempleHitDamage = 0;
  for (let k = 0; k < maxHitsForDKM; k++) {
    sumTempleHitDamage += templeHitDamageTemp[k]; // Use the temporary array
  }
  const expectedDemonKingsMight = sumTempleHitDamage * (add + addExtra) * defier * maimMultiplier * elyvia * 1.2 * 2.5;
  expectedDamage += expectedDemonKingsMight;

  // Calculate expected Balanced Strike (if any crits did not occur)
  let expectedBalancedStrike = 0;
  let bsProc = i < hits;
  if (bsProc) {
      expectedBalancedStrike = expectedDamage * 1.95 * defier * elyvia * (add + addExtra) * maimMultiplier * giantKiller * 2.5;
  }

  // Calculate expected Lethal Fightback
  const lfbMultiplier = 1.0 + (bsProc ? 1.95 : 0);
  const expectedLethalFightback = expectedDamage * 0.18 * defier * giantKiller * (add + addExtra) * maimMultiplier * elyvia * lfbMultiplier * 2.5;

  // Total expected damage for i crits
  const totalExpectedDamage = expectedDamage + expectedBalancedStrike + expectedLethalFightback;

  // Track max expected value and optimal crits
  if (totalExpectedDamage > maxExpectedValue) {
      maxExpectedValue = totalExpectedDamage;
      optimalCrits = i;
  }
}

// --- Calculate Optimal Crit Rate ---
const optimalCritRate = (optimalCrits / hits) * 100; // Convert to percentage

// Display Optimal Crit Rate
document.getElementById('optimalCritRate').value = optimalCritRate.toFixed(2);


let summaryHTML = "<div class='damage-summary'>";

// Hits
summaryHTML += `<div class="section hits"><h3>Hits</h3>`;
templeHitDamage.forEach((hit, i) => {
  let isCrit = false;
  if (critsSelected > 0) isCrit = enemyHP > 60 ? i < Math.min(critsSelected, 3) : i < Math.min(critsSelected, 5);
  summaryHTML += `<div class="hit ${isCrit ? 'crit' : ''}">Hit ${i + 1}${isCrit ? ' (CRIT)' : ''}: <span class="damage-value">${hit.toExponential(2)}</span></div>`;
});
summaryHTML += `</div>`;

// Demon King's Might
summaryHTML += `<div class="section dkm"><h3>Demon King's Might</h3>`;
summaryHTML += `<div class="damage"><span>Demon King's Might: <span class="damage-value">${demonKingsMightTemple.toExponential(2)}</span></span></div></div>`;

// Special Abilities
summaryHTML += `<div class="section abilities"><h3>Special Abilities</h3>`;
summaryHTML += `<div class="damage"><span>Lethal Fightback: <span class="damage-value">${lethalFightback.toExponential(2)}</span></span></div>`;
if (hasNonCrit) {
  summaryHTML += `<div class="damage"><span>Balanced Strike: <span class="damage-value">${balancedStrike.toExponential(2)}</span></span></div>`;
} else {
  summaryHTML += `<div class="damage"><span>Balanced Strike: not triggered</span></div>`;
}
if (additionalDamage > 0) {
  summaryHTML += `<div class="damage"><span>Transition Bonus Damage: <span class="damage-value">${additionalDamage.toExponential(2)}</span></span></div></div>`;
}

// Total Damage (fixed the structure)
summaryHTML += `<div class="section total"><h3>Total Damage</h3><div class="total-value">${total.toExponential(2)}</div></div>`;

summaryHTML += "</div>"; // Close the damage-summary div

document.getElementById('summary').innerHTML = summaryHTML;

// --- Detailed Breakdown ---
const breakdownLines = [];
breakdownLines.push(`<div class="mono"><strong>Base Damage Components</strong></div>`);
breakdownLines.push(`<div class="mono">Attack × (12 + SD + SD Extra): ${attack.toFixed(2)} × ${(12+sd+sdExtra).toFixed(2)} = ${(attack*(12+sd+sdExtra)).toExponential(2)}</div>`);
breakdownLines.push(`<div class="mono">Precision multiplier: 1 + 0.3 × ${precision.toFixed(2)} = ${(1 + 0.3*precision).toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">ADD multiplier: ${(add + addExtra).toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">MAIM multiplier: ${maimMultiplier.toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">Elyvia: ${elyvia.toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">HD: ${hdMultiplier.toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">Pet: ${petMultiplier.toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">DoT1: ${(1+dot1).toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">DoT2: ${(1+dot2).toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">Defier: ${defier.toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">Giant Killer: ${giantKiller.toFixed(4)}</div>`);
breakdownLines.push(`<div class="mono">Artifact: ${artifactMultiplier.toFixed(4)}</div>`);

breakdownLines.push(`<br><div class="mono"><strong>LFA Hits</strong></div>`);
templeHitDamage.forEach((hit,i)=>{
  let isCrit = false;
  if(critsSelected>0) isCrit = enemyHP>60 ? i<Math.min(critsSelected,3):i<Math.min(critsSelected,5);
  breakdownLines.push(`<div class="mono">Hit ${i+1}${isCrit?' (CRIT)':''}: base × dot1 × dot2 × ${isCrit?'critMultiplier × ':''}defier × giantKiller × artifact × 2.5 = ${hit.toExponential(2)}</div>`);
  breakdownLines.push(`<div class="mono">Final: ${baseDamage.toFixed(2)} × ${((1 + dot1) * (1 + dot2)).toFixed(4)} × ${isCrit ? critMultiplier.toFixed(4) : 1} × ${defier.toFixed(4)} × ${giantKiller.toFixed(4)} × 2.5 = ${hit.toExponential(2)}</div>`);
});

breakdownLines.push(`<br><div class="mono"><strong>Demon King's Might (DKM)</strong></div>`);

// Corrected DKM formula without the artifact multiplier
breakdownLines.push(`<div class="mono">Sum(LFA hits) × 1.2 × Temple(2.5) = ${sumTempleHitDamage.toExponential(2)} × 1.2 × 2.5 = ${demonKingsMightTemple.toExponential(2)}</div>`);
breakdownLines.push(`<div class="mono">Final: ${sumTempleHitDamage.toFixed(2)} × 1.2 × 2.5 × ${add.toFixed(4)} × ${elyvia.toFixed(4)} × ${defier.toFixed(4)} × ${maimMultiplier.toFixed(4)} × 2.5 = ${demonKingsMightTemple.toExponential(2)}</div>`);

if(hasNonCrit){
  breakdownLines.push(`<br><div class="mono"><strong>Balanced Strike</strong></div>`);
  breakdownLines.push(`<div class="mono">Subtotal × BS Multiplier(${bsMultiplier.toFixed(4)}) × Defier × Elyvia × ADD × MAIM × GiantKiller × Temple(2.5) = ${balancedStrike.toExponential(2)}</div>`);
  breakdownLines.push(`<div class="mono">Final: ${subtotal.toFixed(2)} × ${bsMultiplier.toFixed(4)} × ${defier.toFixed(4)} × ${elyvia.toFixed(4)} × ${(add + addExtra).toFixed(4)} × ${maimMultiplier.toFixed(4)} × ${giantKiller.toFixed(4)} × 2.5 = ${balancedStrike.toExponential(2)}</div>`);
} else {
  breakdownLines.push(`<div class="mono">Balanced Strike: not triggered</div>`);
}

breakdownLines.push(`<br><div class="mono"><strong>Lethal Fightback</strong></div>`);
breakdownLines.push(`<div class="mono">Subtotal × 0.18 × Defier × GiantKiller × ADD × MAIM × Elyvia × BS Bonus(${lfbMultiplier.toFixed(4)}) × Temple(2.5) = ${lethalFightback.toExponential(2)}</div>`);
breakdownLines.push(`<div class="mono">Final: ${subtotal.toFixed(2)} × 0.18 × ${defier.toFixed(4)} × ${giantKiller.toFixed(4)} × ${(add + addExtra).toFixed(4)} × ${maimMultiplier.toFixed(4)} × ${elyvia.toFixed(4)} × ${lfbMultiplier.toFixed(4)} × 2.5 = ${lethalFightback.toExponential(2)}</div>`);

// --- Additional Damage Calculation ---
// Show the multipliers involved in the additional damage calculation
breakdownLines.push(`<br><div class="mono"><strong>Additional Damage (Transition Point = 12)</strong></div>`);

const additionalDamageMultiplier = (1 + 0.7 * (hdInput / 100)) * (1 + petInput / 100) * (1 + dot1) * (1 + dot2) * (1 + (1 - enemyHP / 100) * (maimInput / 100)) * (add + addExtra) * elyvia;
breakdownLines.push(`<div class="mono">1500% × Attack × 2 (×2 hits) = ${1500 * attack * 2}</div>`);
breakdownLines.push(`<div class="mono">1000% × Attack (×1 hit) = ${1000 * attack}</div>`);
breakdownLines.push(`<div class="mono">${enemyHP < 50 ? '800%' : '1200%'} × Attack (×1 hit) = ${enemyHP < 50 ? 800 * attack : 1200 * attack}</div>`);
breakdownLines.push(`<div class="mono">Additional Damage: Final = 1500% × Attack × 2 × ${additionalDamageMultiplier.toFixed(4)} = ${additionalDamage.toExponential(2)}</div>`);

breakdownLines.push(`<br><div class="mono"><strong>Total Damage</strong>: ${total.toExponential(2)}</div>`);

// --- Final Breakdown HTML ---
document.getElementById('breakdown').innerHTML = breakdownLines.join("");

  
  // --- Contributions (based on TOTAL damage) ---
  const multipliers = [
    { name: 'Attack*(12+SD)', getValue: () => attack*(12+sd+sdExtra) },
    { name: 'Precision', getValue: () => 1 + 0.3*precision },
    { name: 'ADD', getValue: () => add + addExtra },
    { name: 'MAIM', getValue: () => maimMultiplier },
    { name: 'Elyvia', getValue: () => elyvia },
    { name: 'HD', getValue: () => hdMultiplier },
    { name: 'Pet', getValue: () => petMultiplier },
    { name: 'DoT1', getValue: () => 1+dot1 },
    { name: 'DoT2', getValue: () => 1+dot2 },
    { name: 'Defier', getValue: () => defier },
    { name: 'Giant Killer', getValue: () => giantKiller },
    { name: 'Artifact', getValue: () => artifactMultiplier }
  ];

  // Store original total damage
  const totalOriginal = total;

  const impacts = multipliers.map(m => {
    const originalValue = m.getValue();
    
    // Temporarily set this multiplier to neutral 1
    m.getValue = () => 1;

    // Recalculate total damage with this multiplier neutralized
    let subtotalTemp = 0;
    let tempHits = [];
    for (let i = 1; i <= hits; i++) {
      let isCrit = false;
      if (critsSelected > 0) {
        isCrit = enemyHP > 60 ? i <= Math.min(critsSelected, 3) : i <= Math.min(critsSelected, 5);
      }
      const base = 
        multipliers.find(x=>x.name==='Attack*(12+SD)').getValue() *
        multipliers.find(x=>x.name==='Precision').getValue() *
        multipliers.find(x=>x.name==='ADD').getValue() *
        multipliers.find(x=>x.name==='MAIM').getValue() *
        multipliers.find(x=>x.name==='Elyvia').getValue() *
        multipliers.find(x=>x.name==='HD').getValue() *
        multipliers.find(x=>x.name==='Pet').getValue() *
        multipliers.find(x=>x.name==='DoT1').getValue() *
        multipliers.find(x=>x.name==='DoT2').getValue() *
        (isCrit ? critMultiplier : 1) *
        multipliers.find(x=>x.name==='Defier').getValue() *
        multipliers.find(x=>x.name==='Giant Killer').getValue() *
        multipliers.find(x=>x.name==='Artifact').getValue();

      const totalHitDamage = base * 2.5;
      tempHits.push(totalHitDamage);
      subtotalTemp += totalHitDamage;
    }

    const sumTempHits = tempHits.reduce((a,b)=>a+b,0);
    const demonKingsTemp = sumTempHits*1.2*2.5;
    subtotalTemp += demonKingsTemp;

    let balancedStrikeTemp = 0;
    if(hasNonCrit){
      balancedStrikeTemp = subtotalTemp * bsMultiplier * defier * elyvia * (add + addExtra) * maimMultiplier * giantKiller * 2.5;
    }

    let lfbMultiplierTemp = 1.0;
    if(hasNonCrit) lfbMultiplierTemp += bsMultiplier;
    const lethalFightbackTemp = subtotalTemp * 0.18 * defier * giantKiller * (add + addExtra) * maimMultiplier * elyvia * lfbMultiplierTemp * 2.5;

    const totalTemp = subtotalTemp + balancedStrikeTemp + lethalFightbackTemp;

    // Impact is how much total damage changes if multiplier is neutralized
    const impact = totalOriginal - totalTemp;

    // Restore multiplier function
    m.getValue = () => originalValue;

    return { name: m.name, impact };
  });

  // Convert to percentages of total impact
  const sumImpact = impacts.reduce((a,b)=>a+b.impact,0);
  const contribHTML = impacts.map(c=>{
    const pct = ((c.impact / sumImpact)*100).toFixed(2);
    return `<div class="mono">${c.name}: ${pct}%</div>`;
  }).join("");

  // Add disclaimer
  const disclaimerHTML = `
  <div class="small mono" style="margin-top:10px;">
  <strong>Contribution Equation:</strong><br>
  C<sub>i</sub> = 100 × | D<sub>total</sub> - D<sub>total</sub>(m<sub>i</sub>=1) | ÷ Σ<sub>j</sub> | D<sub>total</sub> - D<sub>total</sub>(m<sub>j</sub>=1) |<br>
  where D<sub>total</sub> is the total damage with all multipliers active, and D<sub>total</sub>(m<sub>i</sub>=1) is the total damage with multiplier i set to neutral. Percentages are normalized so that Σ<sub>i</sub> C<sub>i</sub> = 100%.
  </div>
  `;

  // Set contributions tab content
  document.getElementById('contributions').innerHTML = contribHTML + disclaimerHTML;
}

  </script>

</body>
</html>

