<!DOCTYPE html>
<html>
<head>
    <title>Curse of Decay: Full Restoration & HD Tracking</title>
    <style>
        :root { --bg: #0b0e14; --card: #1a1f2e; --accent: #38bdf8; --text: #cbd5e1; --border: #334155; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); padding: 20px; font-size: 12px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 4px; }
        .card h3 { margin: 0 0 8px 0; color: var(--accent); border-bottom: 1px solid var(--border); }
        input, select { background: #000; color: #fff; border: 1px solid var(--border); padding: 4px; width: 100%; margin: 4px 0; }
        button { flex: 1; padding: 15px; font-weight: bold; cursor: pointer; border: 1px solid var(--accent); background: transparent; color: var(--accent); margin-top: 10px; width: 100%; }
        button:hover { background: var(--accent); color: #000; }
        #output { background: #000; border: 1px solid var(--border); padding: 15px; height: 600px; overflow-y: auto; line-height: 1.5; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid var(--border); padding: 6px; text-align: left; }
        th { background: #111; color: var(--accent); }
    </style>
</head>
<body>
<div class="grid" id="hero-inputs"></div>
<div class="card" style="margin-bottom:20px;">
    <h3>Environment Controls</h3>
    <div style="display:flex; gap: 20px;">
        <div style="flex:1"><label>Global Star Imprint</label>
            <select id="gImp"><option value="none">None</option><option value="foresight">Foresight</option><option value="destiny" selected>Destiny</option></select>
        </div>
        <div style="flex:1; margin-top:15px;"><input type="checkbox" id="isl9" checked> <label>Island 9 (Soul Protection)</label></div>
    </div>
</div>
<button onclick="sim(false)">Simulate 15-Round Battle (Full Log + CC/HD Table)</button>
<button onclick="sim(true)">Statistical Batch (30 Fights Summary)</button>
<div id="output"></div>

<script>
const HEROES = ["LFA", "SQH", "STV", "BDSM", "FQV", "LBRM", "ELY", "HW"];
const ARTS = ["None", "Demon Bell", "Mirror", "Antlers", "Scissors"];
const defaults = [
    { h: "BDSM", a: "Demon Bell", s: 2000, ci: 120 },
    { h: "SQH", a: "Mirror", s: 1900, ci: 110 },
    { h: "LFA", a: "Antlers", s: 1500, ci: 200 },
    { h: "HW", a: "Scissors", s: 1800, ci: 80 },
    { h: "ELY", a: "Scissors", s: 1700, ci: 120 },
    { h: "STV", a: "Scissors", s: 1600, ci: 200 }
];

const container = document.getElementById('hero-inputs');
defaults.forEach((d, i) => {
    container.innerHTML += `<div class="card">
        <h3>POS ${i+1}</h3>
        <select id="h${i}">${HEROES.map(h => `<option value="${h}" ${h===d.h?'selected':''}>${h}</option>`).join('')}</select>
        <select id="a${i}">${ARTS.map(a => `<option value="${a}" ${a===d.a?'selected':''}>${a}</option>`).join('')}</select>
        <div style="display:flex; gap:5px;"><input type="number" id="s${i}" value="${d.s}"><input type="number" id="ci${i}" value="${d.ci}"></div>
        <label><input type="checkbox" id="spec${i}"> Soul Specter</label>
        <label><input type="radio" name="max" value="${i}" ${i===0?'checked':''}> Max ATK</label>
    </div>`;
});

let units = [], silent = false, bossHDStacks = 0;

function log(msg, color="#fff") { 
    if(!silent) document.getElementById('output').innerHTML += `<div style="color:${color}">${msg}</div>`; 
}

function checkC(u, type, amount = "") {
    if (u.curse > 0) {
        u.curse--;
        log(`&nbsp;&nbsp;&nbsp;‚ú® [CURSE OFFSET] ${u.name}: ${type} ${amount}`, "#fbbf24");
        return false;
    }
    log(`&nbsp;&nbsp;&nbsp;‚úÖ [BUFF LANDED] ${u.name}: ${type} ${amount}`, "#4ade80");
    return true;
}

function trigCal(u) {
    if (u.calamity >= 5) {
        let p = Math.max(0, 1.0 - (u.baseCI - 1.0));
        ["silence", "fear", "seal"].forEach(t => {
            if (u.imm !== t && Math.random() < p) {
                u.cc[t] = 2;
                log(`&nbsp;&nbsp;&nbsp;üõë [CC APPLIED] ${u.name} is ${t.toUpperCase()}ED!`, "#ef4444");
                if (t === "fear") {
                    bossHDStacks++;
                    log(`&nbsp;&nbsp;&nbsp;üìà [BOSS HD STACK] Fear Landed -> Total Stacks: ${bossHDStacks}`, "#38bdf8");
                }
            }
        });
        u.calamity = 0;
    }
}

function runOne() {
    const imp = document.getElementById('gImp').value;
    const is9 = document.getElementById('isl9').checked;
    const mIdx = parseInt(document.querySelector('input[name="max"]:checked').value);
   
    bossHDStacks = 0;
    units = [];
    for(let i=0; i<6; i++) {
        let art = document.getElementById(`a${i}`).value;
        units.push({
            pos: i+1, name: document.getElementById(`h${i}`).value,
            energy: (art === "Demon Bell" || art === "Mirror") ? 100 : 50,
            curse: 0, calamity: 0, trans: 0, specPity: 0, acts: 0, turnsLost: 0,
            cc: { silence: 0, fear: 0, seal: 0 },
            imm: is9 ? ["silence", "fear", "seal"][Math.floor(Math.random()*3)] : "none",
            art: art, spd: parseInt(document.getElementById(`s${i}`).value),
            baseCI: parseInt(document.getElementById(`ci${i}`).value) / 100,
            hasS: document.getElementById(`spec${i}`).checked, isM: (i === mIdx), isFr: (i < 2), bDone: false
        });
    }

    // Battle Start Specter
    units.forEach(u => {
        if (u.hasS) {
            log(`üîÆ ${u.name} Specter Battle-Start`);
            if(checkC(u, "Spec Start Self", "+50")) u.energy += 50;
            let randAlly = units[Math.floor(Math.random() * 6)];
            if(checkC(randAlly, "Spec Start Team", "+50")) randAlly.energy += 50;
        }
    });

    for (let r = 1; r <= 15; r++) {
        log(`ROUND ${r}`, "#ff4757");

        // SINGLE round-start ATK buff attempt (Trees + Global merged)
        units.forEach(u => {
            if (u.energy >= 100) {
                checkC(u, "Round Start ATK Buff (Energy ‚â•100)", "+30%");
            } else {
                checkC(u, "Global Round ATK Buff", "");
            }
        });

        units.forEach(u => {
            u.bDone = false;
            if (u.name === "STV" && u.trans >= 6 && u.cc.seal <= 0) {
                u.trans -= 6; 
                log(`&nbsp;&nbsp;&nbsp;üíé STV 6-Stack Transition`);
                units.forEach(a => { if(checkC(a, "STV Energy Share", "+20")) a.energy += 20; });
            }
        });

        let ord = [...units].sort((a,b) => b.spd - a.spd);
        ord.forEach(u => {
            let sealed = u.cc.seal > 0;
            log(`--- ${u.name} Moves (Nrg: ${u.energy}) ---`);
           
            if (u.cc.fear > 0 || u.cc.silence > 0 || u.cc.seal > 0) {
                log(`&nbsp;&nbsp;&nbsp;‚ö†Ô∏è CC ACTIVE: ${u.cc.fear > 0?'FEAR ':''}${u.cc.silence > 0?'SILENCE ':''}${u.cc.seal > 0?'SEAL':''}`, "#ef4444");
            }
            if (u.name === "BDSM" && u.energy >= 100 && !u.bDone && !sealed) {
                log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è BDSM Threshold: Backline CI Buff`);
                units.forEach(t => { if(!t.isFr) checkC(t, "BDSM Threshold CI"); });
                u.bDone = true;
            }
            let didHitBoss = false;

            if (u.energy >= 100 && u.cc.silence <= 0) {
                u.energy = 0; u.trans += 6; u.acts++; didHitBoss = true;
                log(`üî• ACTION: Active`);

                // Foresight on active = TWO separate offsettable buffs
                if (imp === "foresight") {
                    checkC(u, "Foresight Crit", "+30%");
                    checkC(u, "Foresight CD", "+100%");
                }

                // Normal active logic...
                units.forEach(target => { 
                    if(target.name === "BDSM" && u.name !== "BDSM" && target.cc.seal <= 0) 
                        if(checkC(target, "BDSM Passive Energy", "+3")) target.energy += 3; 
                });
                if (u.name === "STV") units.forEach(a => { 
                    checkC(a,"STV ATK"); checkC(a,"STV Armor"); checkC(a,"STV DR"); checkC(a,"STV CI"); checkC(a,"STV Speed"); 
                });
                if (u.name === "BDSM") {
                    units.forEach(a => { for(let i=0; i<5; i++) checkC(a, "BDSM Active CI"); });
                    if (Math.random() < 0.4) units.forEach(a => { if(checkC(a, "BDSM Active Team Energy", "+10")) a.energy += 10; });
                }
                if (u.name === "FQV") units.forEach(a => checkC(a, "FQV Armor Buff"));
                if (u.name === "LBRM") u.energy += 50;
                if (u.name === "LFA") checkC(u, "LFA Active ATK Buff");
                if (!sealed && u.art === "Demon Bell") {
                    units.forEach(a => { 
                        if(checkC(a, "DB Energy", "+20")) a.energy += 20; 
                        if(Math.random() < 0.5 && checkC(a, "DB Bonus", "+10")) a.energy += 10; 
                        checkC(a, "DB Speed Buff"); 
                    });
                    // Foresight after DB artifact = TWO separate offsettable buffs
                    if (imp === "foresight") {
                        checkC(u, "Foresight Crit", "+30%");
                        checkC(u, "Foresight CD", "+100%");
                    }
                }
            } else if (u.cc.fear <= 0) {
                u.energy += 50; didHitBoss = true;
                log(`‚öîÔ∏è ACTION: Basic Attack`);

                if (imp === "foresight") {
                    u.energy += 50;
                    log(`&nbsp;&nbsp;&nbsp;üîÆ [FORESIGHT] ${u.name} Basic ‚Üí +50 Energy`, "#38bdf8");
                }

                if (imp === "destiny") {
                    units.forEach(a => {
                        if (Math.random() < 0.75) {
                            a.energy += 20;
                            log(`&nbsp;&nbsp;&nbsp;üåü [DESTINY] ${a.name} +20 Energy (75% proc)`, "#38bdf8");
                            if (Math.random() < 0.50) {
                                a.energy += 20;
                                log(`&nbsp;&nbsp;&nbsp;üåü [DESTINY EXTRA] ${a.name} +20 Energy (50% bonus)`, "#38bdf8");
                            }
                        }
                    });
                }

                if (u.name === "STV" && !sealed) units.forEach(a => { 
                    if(a.isFr) { checkC(a, "STV Front DR"); checkC(a, "STV Front CI"); } 
                    else checkC(a, "STV Back ATK"); 
                });
                if (u.name === "SQH" && !sealed) { checkC(u, "SQH Self Crit"); checkC(u, "SQH Self CD"); }
                if (u.name === "LFA" && !sealed) checkC(u, "LFA Self Crit");
                if (u.name === "BDSM" && !sealed && Math.random() < 0.5) 
                    if(checkC(u, "BDSM Basic Energy", "+20")) u.energy += 20;
            } else {
                u.turnsLost++;
                log(`üö´ ACTION: SKIPPED (Fear)`, "#ef4444");
            }

            if (didHitBoss) {
                u.calamity++; 
                trigCal(u);
                units.forEach(h => { if (Math.random() < 0.5) h.curse++; });
            }

            if (u.trans >= 12 && !sealed) {
                u.trans -= 12; 
                log(`&nbsp;&nbsp;&nbsp;üíé 12-Stack Transition`);
                units.forEach(a => {
                    if(u.name === "SQH" && a !== u) { 
                        checkC(a, "SQH ATK"); 
                        if(checkC(a, "SQH Energy", "+20")) a.energy += 20; 
                        checkC(a, "SQH DR"); 
                    }
                    if(u.name === "BDSM") { 
                        if(checkC(a, "BDSM Energy Share", "+20")) a.energy += 20; 
                    }
                });
            }
        });

        log(`&nbsp;&nbsp;&nbsp;‚òÑÔ∏è BOSS ACTIVE (Cal +2 All)`);
        units.forEach(u => {
            u.curse += 2; 
            u.calamity += 2;
            if(checkC(u, "Boss Hit", "+10")) u.energy += 10;
            trigCal(u);
            for(let k in u.cc) if(u.cc[k] > 0) u.cc[k]--;
        });

        units.forEach(u => {
            if (u.cc.seal > 0) return;
            if(u.art === "Mirror") { 
                log(`&nbsp;&nbsp;&nbsp;ü™û Mirror Trigger`); 
                units.forEach(a => { 
                    if(checkC(a, "Mirror Energy", "+15")) a.energy += 15; 
                    checkC(a, "Mirror DR"); 
                }); 
                // Foresight after Mirror artifact = TWO separate offsettable buffs
                if (imp === "foresight") {
                    checkC(u, "Foresight Crit", "+30%");
                    checkC(u, "Foresight CD", "+100%");
                }
            }
            if(checkC(u, "Global Surge", "+50")) u.energy += 50;
        });

        let d = units.find(u => u.isM);
        d.energy = Math.max(0, d.energy - 100); 
        d.curse += 3;

        units.forEach(u => {
            if (u.calamity > 0) {
                u.calamity--;
                log(`&nbsp;&nbsp;&nbsp;‚ùÑÔ∏è [CALAMITY PURGE] ${u.name}: -1 Calamity (now ${u.calamity})`, "#a5b4fc");
            }
        });
    }

    return { units, hd: bossHDStacks };
}

function sim(multi) {
    const out = document.getElementById('output'); 
    out.innerHTML = ""; 
    silent = multi;
    if(!multi) {
        runOne();
    } else {
        let stats = {}, totalHD = 0;
        for(let i=0; i<30; i++) {
            let res = runOne();
            totalHD += res.hd;
            res.units.forEach(u => {
                if(!stats[u.name]) stats[u.name] = { acts:0, lost:0 };
                stats[u.name].acts += u.acts;
                stats[u.name].lost += u.turnsLost;
            });
        }
        let html = `<h3>AVERAGES (30 FIGHTS)</h3>`;
        html += `<p><b>Avg Boss Holy Damage Stacks (Fear Landed):</b> <span style="color:var(--accent)">${(totalHD/30).toFixed(2)}</span></p>`;
        html += `<table><tr><th>Hero</th><th>Avg Actives</th><th>Avg Turns Lost (CC)</th></tr>`;
        for(let n in stats) {
            html += `<tr><td>${n}</td><td>${(stats[n].acts/30).toFixed(2)}</td><td>${(stats[n].lost/30).toFixed(2)}</td></tr>`;
        }
        out.innerHTML = html + `</table>`;
    }
}
</script>
</body>
</html>
