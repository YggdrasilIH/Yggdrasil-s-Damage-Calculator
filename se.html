<!DOCTYPE html>
<html>
<head>
    <title>Curse of Decay: 1:1 Mechanical Absolute (Final Granular CC)</title>
    <style>
        :root { --bg: #0b0e14; --card: #1a1f2e; --accent: #38bdf8; --text: #cbd5e1; --border: #334155; --danger: #ef4444; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); padding: 20px; font-size: 12px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 4px; }
        .card h3 { margin: 0 0 8px 0; color: var(--accent); border-bottom: 1px solid var(--border); }
        input, select { background: #000; color: #fff; border: 1px solid var(--border); padding: 4px; width: 100%; margin: 4px 0; }
        button { flex: 1; padding: 15px; font-weight: bold; cursor: pointer; border: 1px solid var(--accent); background: transparent; color: var(--accent); margin-top: 10px; width: 100%; }
        button:hover { background: var(--accent); color: #000; }
        #output { background: #000; border: 1px solid var(--border); padding: 15px; height: 600px; overflow-y: auto; line-height: 1.5; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: var(--text); }
        th, td { border: 1px solid var(--border); padding: 8px; text-align: left; }
        th { background: #111; color: var(--accent); }
    </style>
</head>
<body>

<div class="grid" id="hero-inputs"></div>

<div class="card" style="margin-bottom:20px;">
    <h3>Environment Controls</h3>
    <div style="display:flex; gap: 20px;">
        <div style="flex:1"><label>Global Star Imprint</label>
            <select id="gImp">
                <option value="none">None</option>
                <option value="foresight">Foresight</option>
                <option value="destiny" selected>Destiny</option>
            </select>
        </div>
        <div style="flex:1; margin-top:15px;"><input type="checkbox" id="isl9" checked> <label>Island 9 (Soul Protection)</label></div>
    </div>
</div>

<button onclick="sim(false)">Simulate 15-Round Battle (Detailed Log)</button>
<button onclick="sim(true)">Statistical Batch (30 Fights)</button>

<div id="output"></div>

<script>
const HEROES = ["LFA", "SQH", "STV", "BDSM", "FQV", "LBRM", "ELY", "HW"];
const ARTS = ["None", "Demon Bell", "Mirror", "Antlers", "Scissors"];
const defaults = [
    { h: "BDSM", a: "Demon Bell", s: 2000, ci: 120 },
    { h: "SQH",  a: "Mirror",     s: 1900, ci: 110 },
    { h: "LFA",  a: "Antlers",    s: 1500, ci: 200 },
    { h: "HW",   a: "Scissors",   s: 1800, ci: 80  },
    { h: "ELY",  a: "Scissors",   s: 1700, ci: 120 },
    { h: "STV",  a: "Scissors",   s: 1600, ci: 200 }
];

const container = document.getElementById('hero-inputs');
defaults.forEach((d, i) => {
    container.innerHTML += `<div class="card">
        <h3>POS ${i+1}</h3>
        <select id="h${i}">${HEROES.map(h => `<option value="${h}" ${h===d.h?'selected':''}>${h}</option>`).join('')}</select>
        <select id="a${i}">${ARTS.map(a => `<option value="${a}" ${a===d.a?'selected':''}>${a}</option>`).join('')}</select>
        <div style="display:flex; gap:5px;"><input type="number" id="s${i}" value="${d.s}"><input type="number" id="ci${i}" value="${d.ci}"></div>
        <label><input type="checkbox" id="spec${i}"> Soul Specter</label>
        <label><input type="radio" name="max" value="${i}" ${i===0?'checked':''}> Max ATK</label>
    </div>`;
});

let units = [], silent = false;

function log(msg, color="#fff") { if(!silent) document.getElementById('output').innerHTML += `<div style="color:${color}">${msg}</div>`; }

function checkC(u, type, amount = "") {
    if (u.curse > 0) { 
        u.curse--; 
        log(`&nbsp;&nbsp;&nbsp;âœ¨ [CURSE OFFSET] ${u.name}: ${type} ${amount}`, "#fbbf24"); 
        return false; 
    }
    log(`&nbsp;&nbsp;&nbsp;âœ… [BUFF GAINED] ${u.name}: ${type} ${amount}`, "#4ade80"); 
    return true;
}

function trigCal(u) {
    if (u.calamity >= 5) {
        let p = Math.max(0, 1.0 - (u.baseCI - 1.0));
        ["silence", "fear", "seal"].forEach(t => { 
            if (u.imm !== t && Math.random() < p) { 
                u.cc[t] = 2; 
                log(`&nbsp;&nbsp;&nbsp;ðŸ›‘ [CC APPLIED] ${u.name} hit with ${t.toUpperCase()}`, "#ef4444"); 
            } 
        });
        u.calamity = 0;
    }
}

function runOne() {
    const imp = document.getElementById('gImp').value;
    const is9 = document.getElementById('isl9').checked;
    const mIdx = parseInt(document.querySelector('input[name="max"]:checked').value);
    
    units = [];
    for(let i=0; i<6; i++) {
        let art = document.getElementById(`a${i}`).value;
        units.push({
            pos: i+1, name: document.getElementById(`h${i}`).value, 
            energy: (art === "Demon Bell" || art === "Mirror") ? 100 : 50,
            curse: 0, calamity: 0, trans: 0, specPity: 0, acts: 0, ccLogs: [],
            cc: { silence: 0, fear: 0, seal: 0 },
            imm: is9 ? ["silence", "fear", "seal"][Math.floor(Math.random()*3)] : "none",
            art: art, spd: parseInt(document.getElementById(`s${i}`).value),
            baseCI: parseInt(document.getElementById(`ci${i}`).value) / 100,
            hasS: document.getElementById(`spec${i}`).checked, isM: (i === mIdx), isFr: (i < 2), bDone: false
        });
    }

    // Battle Start Specters
    units.forEach(u => {
        if (u.hasS) {
            log(`ðŸ”® ${u.name} Specter Battle-Start`);
            if(checkC(u, "Spec Start Self", "+50")) u.energy += 50;
            let randAlly = units[Math.floor(Math.random() * 6)];
            if(checkC(randAlly, "Spec Start Team", "+50")) randAlly.energy += 50;
        }
    });

    for (let r = 1; r <= 15; r++) {
        log(`ROUND ${r}`, "#ff4757");
        units.forEach(u => {
            u.bDone = false;
            checkC(u, "Global Round ATK Buff");
            if (u.name === "STV" && u.trans >= 6 && u.cc.seal <= 0) { 
                u.trans -= 6; log(`&nbsp;&nbsp;&nbsp;ðŸ’Ž STV 6-Stack Transition`); 
                units.forEach(a => { if(checkC(a, "STV Energy Share", "+20")) a.energy += 20; }); 
            }
        });

        let ord = [...units].sort((a,b) => b.spd - a.spd);
        ord.forEach(u => {
            let sealed = u.cc.seal > 0;
            let usedActive = false, usedBasic = false, actionResult = "None";
            
            // Log CC state before move
            let currentCCs = [];
            if (u.cc.silence > 0) currentCCs.push("Silence");
            if (u.cc.fear > 0) currentCCs.push("Fear");
            if (u.cc.seal > 0) currentCCs.push("Seal");

            log(`--- ${u.name} Moves (Nrg: ${u.energy}) ---`);

            // BDSM Active check before move
            if (u.name === "BDSM" && u.energy >= 100 && !u.bDone && !sealed) {
                units.forEach(t => { if(!t.isFr) checkC(t, "BDSM Threshold CI"); });
                u.bDone = true;
            }

            // Action Selection
            if (u.energy >= 100 && u.cc.silence <= 0) {
                u.energy = 0; u.trans += 6; u.acts++; usedActive = true;
                actionResult = u.cc.fear > 0 ? "Active (while Feared)" : "Active";
                log(`ðŸ”¥ ${actionResult}`);
                
                if (u.name === "STV") {
                    units.forEach(a => { 
                        checkC(a,"STV ATK"); checkC(a,"STV Armor"); checkC(a,"STV DR"); 
                        checkC(a,"STV CI"); checkC(a,"STV Speed"); 
                    });
                }
                if (u.name === "BDSM") {
                    units.forEach(a => { for(let i=0; i<5; i++) checkC(a, "BDSM Active CI"); });
                    if (Math.random() < 0.4) units.forEach(a => { if(checkC(a, "BDSM Energy", "+10")) a.energy += 10; });
                }
                if (u.name === "FQV") units.forEach(a => checkC(a, "FQV Armor Buff"));
                if (u.name === "LBRM") u.energy += 50;
                if (u.name === "LFA") checkC(u, "LFA Active ATK");

                if (!sealed && u.art === "Demon Bell") {
                    units.forEach(a => { 
                        if(checkC(a, "DB Energy", "+20")) a.energy += 20; 
                        if(Math.random() < 0.5 && checkC(a, "DB Bonus", "+10")) a.energy += 10; 
                        checkC(a, "DB Speed"); 
                    });
                }
            } else if (u.cc.fear <= 0) {
                u.energy += 50; usedBasic = true; actionResult = "Basic";
                log(`âš”ï¸ Basic Attack`);
                if (u.name === "STV" && !sealed) {
                    units.forEach(a => { if(a.isFr) { checkC(a, "STV Fr DR"); checkC(a, "STV Fr CI"); } else checkC(a, "STV Bk ATK"); });
                }
                if (u.name === "SQH" && !sealed) { checkC(u, "SQH Crit"); checkC(u, "SQH CD"); }
                if (u.name === "LFA" && !sealed) checkC(u, "LFA Crit");
            } else {
                actionResult = "SKIPPED (Fear)";
                log(`ðŸš« ${u.name} skips due to Fear`, "#ef4444");
            }

            // Track CC for summary
            if (currentCCs.length > 0) {
                u.ccLogs.push({ r: r, types: currentCCs.join("+"), action: actionResult });
            }

            // Transitions
            if (u.trans >= 12 && !sealed) {
                u.trans -= 12; log(`&nbsp;&nbsp;&nbsp;ðŸ’Ž 12-Stack Transition`);
                if (u.name === "LFA") checkC(u, "LFA Trans CI");
                else {
                    units.forEach(a => {
                        if (u.name === "SQH" && a !== u) { checkC(a, "SQH ATK"); if(checkC(a, "SQH Energy", "+20")) a.energy += 20; checkC(a, "SQH DR"); }
                        if (u.name === "FQV") { checkC(a, "FQV ATK"); checkC(a, "FQV Armor"); if(checkC(a, "FQV Energy", "+20")) a.energy += 20; }
                        if (u.name === "BDSM") { if(checkC(a, "BDSM Trans Energy", "+20")) a.energy += 20; }
                    });
                }
            }

            // Star Soul Logic
            if (u.hasS && !sealed) {
                let chance = (u.specPity >= 3) ? 1.0 : 0.333;
                if (Math.random() < chance) {
                    u.specPity = 0; log(`&nbsp;&nbsp;&nbsp;âœ¨ STAR SOUL TRIGGER!`);
                    let f = [...units].sort((a,b)=>b.spd-a.spd)[0];
                    if(checkC(f, "Star Soul Team", "+100")) f.energy += 100;
                    if(checkC(u, "Star Soul Self", "+50")) u.energy += 50;
                } else u.specPity++;
            }

            // Imprints (Destiny LBRM Rule)
            if (imp === "foresight") {
                if (usedBasic && checkC(u, "Foresight Energy", "+50")) u.energy += 50;
            } else if (imp === "destiny") {
                if (usedBasic || (u.name === "LBRM" && usedActive)) {
                    units.forEach(a => { if(Math.random() < 0.75) if(checkC(a, "Destiny Energy", "+20")) a.energy += 20; });
                }
            }

            u.calamity++; trigCal(u);
            units.forEach(h => { if (Math.random() < 0.5) h.curse++; }); // Global Counter
        });

        // Boss Active Phase
        units.forEach(u => { 
            u.curse += 2; u.calamity += 2; 
            if(checkC(u, "Boss Hit", "+10")) u.energy += 10;
            trigCal(u); 
        });

        // EOR Phase
        units.forEach(u => {
            if (u.cc.seal > 0) return;
            if(u.art === "Mirror") units.forEach(a => { if(checkC(a, "Mirror Energy", "+15")) a.energy += 15; checkC(a, "Mirror DR"); });
            if(u.art === "Antlers") checkC(u, "Antlers DR");
            if(u.art === "Scissors") units.forEach(a => { if(a.isFr === u.isFr) { checkC(a, "Scissors ATK"); checkC(a, "Scissors HD"); }});
            if(checkC(u, "Global Surge", "+50")) u.energy += 50;
        });

        let d = units.find(u => u.isM); 
        d.energy = Math.max(0, d.energy - 100); d.curse += 3;
        units.forEach(u => { for(let k in u.cc) if(u.cc[k]>0) u.cc[k]--; if(u.calamity>0) u.calamity--; });
    }
    return units;
}

function sim(multi) {
    const out = document.getElementById('output'); out.innerHTML = ""; silent = multi;
    if(!multi) {
        let res = runOne();
        let html = `<h3>DETAILED CC LOG</h3><table><tr><th>Hero</th><th>Round</th><th>CCs at Start</th><th>Action Taken</th></tr>`;
        res.forEach(u => {
            u.ccLogs.forEach(l => {
                html += `<tr><td>${u.name}</td><td>${l.r}</td><td>${l.types}</td><td>${l.action}</td></tr>`;
            });
        });
        out.innerHTML = html + `</table>`;
    } else {
        let stats = {};
        for(let i=0; i<30; i++) {
            runOne().forEach(u => {
                if(!stats[u.name]) stats[u.name] = { acts:0, ccTurns:0 };
                stats[u.name].acts += u.acts;
                stats[u.name].ccTurns += u.ccLogs.length;
            });
        }
        let html = `<h3>STATISTICAL SUMMARY (30 FIGHTS)</h3><table><tr><th>Hero</th><th>Avg Actives</th><th>Avg Turns w/ CC</th></tr>`;
        for(let n in stats) html += `<tr><td>${n}</td><td>${(stats[n].acts/30).toFixed(2)}</td><td>${(stats[n].ccTurns/30).toFixed(2)}</td></tr>`;
        out.innerHTML = html + `</table>`;
    }
}
</script>
</body>
</html>
