<!DOCTYPE html>
<html>
<head>
    <title>Curse of Decay - Statistical Engine</title>
    <style>
        body { font-family: 'Consolas', monospace; background: #0a0a0c; color: #00d4ff; padding: 20px; font-size: 12px; }
        .setup { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #1a1a24; padding: 15px; border: 1px solid #333; margin-bottom: 10px; }
        .hero-box { border: 1px solid #444; padding: 8px; background: #12121a; }
        .summary { background: #161b33; border: 2px solid #2ed573; padding: 20px; color: #fff; border-radius: 8px; font-size: 14px; line-height: 1.8; }
        select, input, button { background: #000; color: #00d4ff; border: 1px solid #00d4ff; width: 100%; padding: 4px; margin-bottom: 4px; box-sizing: border-box; }
        button { background: #2ed573; color: #000; font-weight: bold; height: 50px; cursor: pointer; margin-top: 10px; border: none; font-size: 16px; }
        label { font-size: 10px; display: block; }
        .stat-val { color: #2ed573; font-weight: bold; }
    </style>
</head>
<body>

<div id="ui" class="setup"></div>
<div class="setup">
    <div class="hero-box">
        <strong>Global Settings</strong>
        <label>Imprint: <select id="globalImprint"><option value="None">None</option><option value="Foresight">Foresight</option><option value="Destiny" selected>Destiny</option></select></label>
        <label><input type="checkbox" id="island9" checked> Island 9 (Soul Protection)</label>
    </div>
</div>
<button onclick="runMulti(30)">RUN 30X SIMULATION</button>
<div id="summary" class="summary" style="display:none; margin-top: 20px;"></div>

<script>
const HEROES = ["LFA", "SQH", "STV", "BDSM", "FQV", "LBRM", "ELY", "HW"];
const ARTS = ["None", "Demon Bell", "Mirror", "Antlers", "Scissors"];

const defaults = [
    { h: "BDSM", a: "Demon Bell", s: 2000, ci: 120 },
    { h: "SQH",  a: "Mirror",     s: 1900, ci: 110 },
    { h: "LFA",  a: "Antlers",    s: 1500, ci: 200 },
    { h: "HW",   a: "Scissors",   s: 1800, ci: 80  },
    { h: "ELY",  a: "Scissors",   s: 1700, ci: 120 },
    { h: "STV",  a: "Scissors",   s: 1600, ci: 200 }
];

const ui = document.getElementById('ui');
for(let i=1; i<=6; i++) {
    const d = defaults[i-1];
    ui.innerHTML += `
        <div class="hero-box">
            POS ${i} | <select id="h${i}">${HEROES.map(h => `<option value="${h}" ${h===d.h?'selected':''}>${h}</option>`).join('')}</select>
            ART: <select id="a${i}">${ARTS.map(a => `<option value="${a}" ${a===d.a?'selected':''}>${a}</option>`).join('')}</select>
            SPD: <input type="number" id="s${i}" value="${d.s}">
            CI%: <input type="number" id="ci${i}" value="${d.ci}">
            <label><input type="checkbox" id="spec${i}"> Specter</label>
            <label style="color:red;"><input type="radio" name="maxatk" value="${i}" ${i===1?'checked':''}> Max ATK</label>
        </div>`;
}

let units = [];
let holyHits = 0;

function checkCurse(u) {
    if (u.curse > 0) { u.curse--; return false; }
    return true;
}

function checkBDSMThreshold() {
    for (let u of units) {
        if (u.name === "BDSM" && u.energy >= 100 && !u.bdsmCIGiven && u.cc.seal <= 0) {
            u.bdsmCIGiven = true;
        }
    }
}

function triggerCalamityCheck(u) {
    if (u.calamity >= 5) {
        let failChance = Math.max(0, 1.0 - (u.baseCI - 1.0));
        if (Math.random() < failChance && u.immuneTo !== "silence") u.cc.silence = 2;
        if (Math.random() < failChance && u.immuneTo !== "fear") u.cc.fear = 2;
        if (Math.random() < failChance && u.immuneTo !== "seal") u.cc.seal = 2;
        u.calamity = 0;
    }
}

function triggerBossCounter() {
    units.forEach(u => {
        u.calamity++;
        if (Math.random() < 0.5) u.curse++;
        triggerCalamityCheck(u);
    });
    checkBDSMThreshold();
}

function runSingleBattle() {
    const maxAtkIdx = parseInt(document.querySelector('input[name="maxatk"]:checked').value);
    const imprint = document.getElementById('globalImprint').value;
    const isIsland9 = document.getElementById('island9').checked;
    const ccTypes = ["silence", "fear", "seal"];
    
    units = [];
    holyHits = 0;

    for(let i=1; i<=6; i++) {
        let art = document.getElementById(`a${i}`).value;
        units.push({
            name: document.getElementById(`h${i}`).value,
            energy: (art === "Demon Bell" || art === "Mirror") ? 100 : 50,
            curse: 0, calamity: 0, trans: 0, specPity: 0, activeCount: 0,
            cc: { silence: 0, fear: 0, seal: 0 },
            immuneTo: isIsland9 ? ccTypes[Math.floor(Math.random()*3)] : "none",
            art: art, spd: parseInt(document.getElementById(`s${i}`).value),
            baseCI: parseInt(document.getElementById(`ci${i}`).value) / 100,
            hasSpec: document.getElementById(`spec${i}`).checked,
            isMax: (i === maxAtkIdx), isFront: (i <= 2), bdsmCIGiven: false
        });
    }

    for (let r = 1; r <= 15; r++) {
        units.forEach(u => u.bdsmCIGiven = false);
        // Stage 1
        units.forEach(u => {
            if (u.name === "STV" && u.trans >= 6 && u.cc.seal <= 0) {
                u.trans -= 6;
                units.forEach(a => { if(checkCurse(a)) a.energy += 20; });
            }
        });
        checkBDSMThreshold();

        // Stage 2
        let order = [...units].sort((a,b) => b.spd - a.spd);
        for(let u of order) {
            let isSealed = u.cc.seal > 0;
            let acted = false;
            if (u.energy >= 100 && u.cc.silence <= 0) {
                u.energy = 0; u.trans += 6; acted = true; u.activeCount++;
                units.forEach(b => { if(b.name === "BDSM") { if(checkCurse(b)) b.energy += 3; } });
                if (u.name === "STV") { /* No internal energy triggers */ }
                if (u.name === "BDSM") {
                    if(Math.random() < 0.4) units.forEach(a => { if(checkCurse(a)) a.energy += 10; });
                }
                if (u.name === "LBRM") u.energy += 50;
                if (u.art === "Demon Bell" && !isSealed) {
                    units.forEach(a => { 
                        if(checkCurse(a)) a.energy += 20; 
                        if(Math.random() < 0.5) { if(checkCurse(a)) a.energy += 10; }
                    });
                }
            } else if (u.cc.fear <= 0) {
                u.energy += 50; acted = true;
                if (u.name === "BDSM" && !isSealed && Math.random() < 0.5) { if(checkCurse(u)) u.energy += 20; }
                if (imprint === "Foresight" && !isSealed) { if(checkCurse(u)) u.energy += 50; }
            } else { holyHits++; }

            if (acted) {
                triggerBossCounter();
                if (imprint === "Destiny" && !isSealed) {
                    if (Math.random() < 0.75) {
                        units.forEach(a => { 
                            let gain = (Math.random() < 0.5) ? 40 : 20;
                            if(checkCurse(a)) a.energy += gain; 
                        });
                    }
                }
                if (u.hasSpec && !isSealed) {
                    u.specPity++;
                    if (Math.random() < 0.33 || u.specPity >= 4) {
                        u.specPity = 0;
                        if(checkCurse(u)) u.energy += 50;
                        let fast = [...units].sort((a,b)=>b.spd-a.spd)[0];
                        if(checkCurse(fast)) fast.energy += 100;
                    }
                }
            }
            if (u.trans >= 12 && !isSealed) {
                u.trans -= 12;
                if (u.name === "SQH") units.forEach(a => { if(checkCurse(a)) a.energy += 20; });
                if (u.name === "FQV") units.forEach(a => { if(checkCurse(a)) a.energy += 20; });
                if (u.name === "BDSM") units.forEach(a => { if(checkCurse(a)) a.energy += 20; });
            }
            checkBDSMThreshold();
        }

        // Stage 3
        units.forEach(u => { u.curse += 2; u.calamity += 2; if(checkCurse(u)) u.energy += 10; triggerCalamityCheck(u); });
        
        // Stage 4
        units.forEach(u => {
            let ccs = []; if(u.cc.silence>0 && u.immuneTo!=="silence") ccs.push("silence"); if(u.cc.fear>0 && u.immuneTo!=="fear") ccs.push("fear"); if(u.cc.seal>0 && u.immuneTo!=="seal") ccs.push("seal");
            if(ccs.length > 0) u.cc[ccs[Math.floor(Math.random()*ccs.length)]] = 0;
        });
        units.forEach(u => {
            if (u.cc.seal > 0) return;
            if (u.art === "Mirror") units.forEach(a => { if(checkCurse(a)) a.energy += 15; });
            if (u.hasSpec && r <= 5) { if(checkCurse(u)) u.energy += 50; let ra = units[Math.floor(Math.random()*6)]; if(checkCurse(ra)) ra.energy += 50; }
        });
        units.forEach(u => { if(u.cc.seal <= 0) { if(checkCurse(u)) u.energy += 50; } });
        
        // Stage 5
        let d = units.find(u => u.isMax); d.energy = Math.max(0, d.energy - 100); d.curse += 3;
        units.forEach(u => { 
            if(u.cc.silence>0) u.cc.silence--; if(u.cc.fear>0) u.cc.fear--; if(u.cc.seal>0) u.cc.seal--; if(u.calamity>0) u.calamity--; 
        });
    }

    return { actives: units.map(u => ({name: u.name, count: u.activeCount})), holy: holyHits };
}

function runMulti(iterations) {
    const sumDiv = document.getElementById('summary');
    sumDiv.style.display = "block";
    sumDiv.innerHTML = "Processing Simulation...";
    
    let totalActives = {};
    let totalHoly = 0;

    for (let i = 0; i < iterations; i++) {
        let result = runSingleBattle();
        totalHoly += result.holy;
        result.actives.forEach(a => {
            totalActives[a.name] = (totalActives[a.name] || 0) + a.count;
        });
    }

    let output = `<strong>AVERAGE RESULTS OVER ${iterations} FIGHTS</strong><hr>`;
    output += `Boss Holy Damage Gain Frequency: <span class="stat-val">${(totalHoly / iterations).toFixed(2)} times/fight</span><br><br>`;
    output += `<strong>Average Actives Per Hero:</strong><br>`;
    
    for (let hero in totalActives) {
        output += `${hero}: <span class="stat-val">${(totalActives[hero] / iterations).toFixed(2)}</span><br>`;
    }

    sumDiv.innerHTML = output;
}
</script>
</body>
</html>
