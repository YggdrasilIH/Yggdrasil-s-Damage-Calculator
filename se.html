
<!DOCTYPE html>
<html>
<head>
    <title>Curse of Decay: Full Restoration & HD Tracking</title>
    <style>
        :root { --bg: #0b0e14; --card: #1a1f2e; --accent: #38bdf8; --text: #cbd5e1; --border: #334155; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--text); padding: 20px; font-size: 12px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 12px; border-radius: 4px; }
        .card h3 { margin: 0 0 8px 0; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom:4px; }
        input, select { background: #000; color: #fff; border: 1px solid var(--border); padding: 4px; width: 100%; margin: 4px 0; box-sizing:border-box; }
        label { display:block; margin: 3px 0; }
        button { padding: 15px; font-weight: bold; cursor: pointer; border: 1px solid var(--accent); background: transparent; color: var(--accent); margin-top: 10px; width: 100%; }
        button:hover { background: var(--accent); color: #000; }
        #output { background: #000; border: 1px solid var(--border); padding: 15px; height: 600px; overflow-y: auto; line-height: 1.5; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid var(--border); padding: 6px; text-align: left; }
        th { background: #111; color: var(--accent); }
        small { color: #64748b; }
    </style>
</head>
<body>

<div class="grid" id="hero-inputs"></div>

<div class="card" style="margin-bottom:12px;">
    <h3>üëÅÔ∏è Pupil ‚Äî 3 Lowest HP Heroes</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <div style="flex:1"><label>Lowest HP #1</label><select id="lowhp0"><option value="">-- None --</option></select></div>
        <div style="flex:1"><label>Lowest HP #2</label><select id="lowhp1"><option value="">-- None --</option></select></div>
        <div style="flex:1"><label>Lowest HP #3</label><select id="lowhp2"><option value="">-- None --</option></select></div>
    </div>
    <small style="margin-top:4px;display:block;">Every 4 Pupil-wearer actions ‚Üí these 3 heroes get 100% boss-active dodge for 2 rounds.</small>
</div>

<div class="card" style="margin-bottom:20px;">
    <h3>Environment Controls</h3>
    <div style="display:flex; gap:20px;">
        <div style="flex:1"><label>Global Star Imprint</label>
            <select id="gImp"><option value="none">None</option><option value="foresight">Foresight</option><option value="destiny" selected>Destiny</option></select>
        </div>
        <div style="flex:1; margin-top:15px;"><label><input type="checkbox" id="isl9" checked> Island 9 (Soul Protection)</label></div>
    </div>
</div>

<button onclick="sim(false)">Simulate 15-Round Battle (Full Log)</button>
<button onclick="sim(true)">Statistical Batch (30 Fights Summary)</button>
<div id="output"></div>

<script>
const HEROES = ["LFA","SQH","STV","BDSM","FQV","LBRM","ELY","HW"];
const ARTS   = ["None","Demon Bell","Mirror","Antlers","Scissors"];
const defaults = [
    { h:"BDSM", a:"Demon Bell", s:2000, ci:120 },
    { h:"SQH",  a:"Mirror",    s:1900, ci:110 },
    { h:"LFA",  a:"Antlers",   s:1500, ci:200 },
    { h:"HW",   a:"Scissors",  s:1800, ci:80  },
    { h:"ELY",  a:"Scissors",  s:1700, ci:120 },
    { h:"STV",  a:"Scissors",  s:1600, ci:200 }
];

const container = document.getElementById('hero-inputs');
defaults.forEach((d, i) => {
    container.innerHTML += `<div class="card">
        <h3>POS ${i+1}</h3>
        <select id="h${i}">${HEROES.map(h=>`<option value="${h}" ${h===d.h?'selected':''}>${h}</option>`).join('')}</select>
        <select id="a${i}">${ARTS.map(a=>`<option value="${a}" ${a===d.a?'selected':''}>${a}</option>`).join('')}</select>
        <div style="display:flex;gap:5px;">
            <input type="number" id="s${i}"  value="${d.s}"  placeholder="SPD">
            <input type="number" id="ci${i}" value="${d.ci}" placeholder="CI%">
            <input type="number" id="dg${i}" value="0" min="0" max="100" placeholder="Dodge%">
        </div>
        <label><input type="checkbox" id="spec${i}"> Soul Specter</label>
        <label><input type="checkbox" id="pupil${i}"> Pupil</label>
        <label><input type="checkbox" id="nova${i}"> Nova</label>
        <label><input type="radio" name="max" value="${i}" ${i===0?'checked':''}> Max ATK</label>
    </div>`;
});

// Populate the Pupil low-HP dropdowns from current hero names
function refreshLowHPDropdowns() {
    for (let s = 0; s < 3; s++) {
        let sel = document.getElementById(`lowhp${s}`);
        let cur = sel.value;
        sel.innerHTML = '<option value="">-- None --</option>';
        for (let i = 0; i < 6; i++) {
            let name = document.getElementById(`h${i}`).value;
            sel.innerHTML += `<option value="${i}" ${cur==i?'selected':''}>${name} (POS ${i+1})</option>`;
        }
    }
}
window.addEventListener('load', () => {
    refreshLowHPDropdowns();
    for (let i = 0; i < 6; i++) document.getElementById(`h${i}`).addEventListener('change', refreshLowHPDropdowns);
});

let units = [], silent = false, bossHDStacks = 0;

function log(msg, color="#fff") {
    if (!silent) document.getElementById('output').innerHTML += `<div style="color:${color}">${msg}</div>`;
}

function checkC(u, type, amount="") {
    if (u.curse > 0) {
        u.curse--;
        log(`&nbsp;&nbsp;&nbsp;‚ú® [CURSE OFFSET] ${u.name}: ${type} ${amount}`, "#fbbf24");
        return false;
    }
    log(`&nbsp;&nbsp;&nbsp;‚úÖ [BUFF LANDED] ${u.name}: ${type} ${amount}`, "#4ade80");
    return true;
}

function trigCal(u) {
    if (u.calamity >= 5) {
        let p = Math.max(0, 1.0 - (u.baseCI - 1.0));
        ["silence","fear","seal"].forEach(t => {
            if (u.imm !== t && Math.random() < p) {
                u.cc[t] = 2;
                log(`&nbsp;&nbsp;&nbsp;üõë [CC APPLIED] ${u.name} is ${t.toUpperCase()}ED!`, "#ef4444");
                if (t === "fear") {
                    bossHDStacks++;
                    log(`&nbsp;&nbsp;&nbsp;üìà [BOSS HD STACK] Fear Landed -> Total Stacks: ${bossHDStacks}`, "#38bdf8");
                }
            }
        });
        u.calamity = 0;
    }
}

// ‚îÄ‚îÄ Star Soul Skill / Burst ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tryStarSoul(u) {
    if (!u.hasS) return;
    let triggered = Math.random() < 0.333;
    u.starSoulTally++;
    if (u.starSoulTally >= 3) {
        triggered = true;
        u.starSoulTally = 0;
        log(`&nbsp;&nbsp;&nbsp;üí• [STAR SOUL BURST] ${u.name} guaranteed burst!`, "#f472b6");
    }
    if (triggered) {
        let fastest = units.reduce((a,b) => b.spd > a.spd ? b : a);
        log(`&nbsp;&nbsp;&nbsp;‚≠ê [STAR SOUL SKILL] ${u.name}: +100 to ${fastest.name} (highest SPD), +50 to self`, "#f472b6");
        if (checkC(fastest, "Star Soul +100 Energy", "+100")) fastest.energy += 100;
        if (checkC(u, "Star Soul Self +50", "+50")) u.energy += 50;
    }
}

// ‚îÄ‚îÄ Pupil: fires after every action taken by the Pupil wearer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 1. After each action: +22% dodge to the Max ATK (highest ATK) ally
// 2. Every 4 actions: 3 lowest-HP heroes get 100% boss-active dodge for 2 rounds
// 3. After any successful dodge by any hero: Pupil wearer gets +10 energy
//    (tracked via u.pupilDodgesThisRound, resolved in the boss active phase)
function triggerPupil(actor) {
    if (!actor.hasPupil) return;

    // ‚îÄ‚îÄ Effect 1: +22% dodge to Max ATK ally ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let maxAtkHero = units.find(u => u.isM);
    if (maxAtkHero && maxAtkHero !== actor) {
        let prev = Math.round(maxAtkHero.dodge * 100);
        maxAtkHero.dodge = Math.min(1, maxAtkHero.dodge + 0.22);
        log(`&nbsp;&nbsp;&nbsp;üëÅÔ∏è [PUPIL] ${maxAtkHero.name} (Max ATK) Dodge: ${prev}% ‚Üí ${Math.round(maxAtkHero.dodge*100)}% (+22%, resets end of round)`, "#e879f9");
    } else if (maxAtkHero === actor) {
        // Pupil wearer IS the max ATK hero ‚Äî buff self
        let prev = Math.round(actor.dodge * 100);
        actor.dodge = Math.min(1, actor.dodge + 0.22);
        log(`&nbsp;&nbsp;&nbsp;üëÅÔ∏è [PUPIL] ${actor.name} (Max ATK = self) Dodge: ${prev}% ‚Üí ${Math.round(actor.dodge*100)}% (+22%, resets end of round)`, "#e879f9");
    }

    // ‚îÄ‚îÄ Effect 2: every 4 actions ‚Üí 100% dodge for 2 rounds on low-HP trio ‚îÄ
    actor.pupilActionCount++;
    log(`&nbsp;&nbsp;&nbsp;üëÅÔ∏è [PUPIL] ${actor.name} action count: ${actor.pupilActionCount}/4`, "#e879f9");
    if (actor.pupilActionCount >= 4) {
        actor.pupilActionCount = 0;
        log(`&nbsp;&nbsp;&nbsp;üëÅÔ∏è [PUPIL BURST] 4-action threshold! Granting 100% dodge (2 rounds) to low-HP heroes`, "#e879f9");
        units.filter(u => u.isLowHP).forEach(u => {
            u.pupilDodgeRounds = 2;
            log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üëÅÔ∏è ‚Üí ${u.name} has 100% dodge for 2 rounds`, "#e879f9");
        });
    }
}

// ‚îÄ‚îÄ Nova: every 4th action grants +100 energy to self ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerNova(u) {
    if (!u.hasNova) return;
    u.novaActionCount++;
    log(`&nbsp;&nbsp;&nbsp;üí´ [NOVA] ${u.name} action count: ${u.novaActionCount}/4`, "#fcd34d");
    if (u.novaActionCount >= 4) {
        u.novaActionCount = 0;
        u.energy += 100;
        log(`&nbsp;&nbsp;&nbsp;üí´ [NOVA BURST] ${u.name} +100 Energy (direct)! (now ${u.energy})`, "#fcd34d");
    }
}

function runOne() {
    const imp  = document.getElementById('gImp').value;
    const is9  = document.getElementById('isl9').checked;
    const mIdx = parseInt(document.querySelector('input[name="max"]:checked').value);

    bossHDStacks = 0;
    units = [];

    for (let i = 0; i < 6; i++) {
        let art = document.getElementById(`a${i}`).value;
        units.push({
            pos: i+1,
            name: document.getElementById(`h${i}`).value,
            energy: (art === "Demon Bell" || art === "Mirror") ? 100 : 50,
            curse: 0, calamity: 0, trans: 0, acts: 0, turnsLost: 0,
            cc: { silence:0, fear:0, seal:0 },
            imm: is9 ? ["silence","fear","seal"][Math.floor(Math.random()*3)] : "none",
            art: art,
            spd: parseInt(document.getElementById(`s${i}`).value),
            baseCI: parseInt(document.getElementById(`ci${i}`).value) / 100,
            hasS: document.getElementById(`spec${i}`).checked,
            hasPupil: document.getElementById(`pupil${i}`).checked,
            isM: (i === mIdx), isFr: (i < 2), bDone: false,
            dodge: (parseInt(document.getElementById(`dg${i}`).value) || 0) / 100,
            baseDodge: (parseInt(document.getElementById(`dg${i}`).value) || 0) / 100,
            starSoulTally: 0,
            pupilActionCount: 0,   // counts toward the 4-action Pupil burst
            pupilDodgeRounds: 0,   // rounds of 100% boss-active dodge remaining (from Pupil burst)
            hasNova: document.getElementById(`nova${i}`).checked,
            novaActionCount: 0,   // counts toward the 4-action Nova energy burst
            isLowHP: false
        });
    }

    // Flag the 3 lowest-HP heroes chosen by user
    for (let s = 0; s < 3; s++) {
        let val = document.getElementById(`lowhp${s}`).value;
        if (val !== "" && units[parseInt(val)]) units[parseInt(val)].isLowHP = true;
    }
    let lowHPNames = units.filter(u => u.isLowHP).map(u => u.name).join(", ");
    let pupilWearers = units.filter(u => u.hasPupil).map(u => u.name).join(", ");
    log(`üëÅÔ∏è PUPIL wearers: ${pupilWearers || "none"} | Low-HP targets: ${lowHPNames || "none"}`, "#e879f9");

    // Battle Start Specter logic
    units.forEach(u => {
        if (u.hasS) {
            log(`üîÆ ${u.name} Specter Battle-Start`);
            if (checkC(u, "Spec Start Self", "+50")) u.energy += 50;
            let randAlly = units[Math.floor(Math.random() * units.length)];
            if (checkC(randAlly, "Spec Start Team", "+50")) randAlly.energy += 50;
        }
    });

    for (let r = 1; r <= 15; r++) {
        log(`ROUND ${r}`, "#ff4757");

        // Decrement Pupil low-HP dodge window each round
        units.forEach(u => { if (u.pupilDodgeRounds > 0) u.pupilDodgeRounds--; });

        // Round-start ATK buff for heroes at ‚â•100 energy
        units.forEach(u => {
            if (u.energy >= 100) checkC(u, "Round Start ATK Buff (Energy ‚â•100)", "+30%");
        });

        // STV 6-stack check
        units.forEach(u => {
            u.bDone = false;
            if (u.name === "STV" && u.trans >= 6 && u.cc.seal <= 0) {
                u.trans -= 6;
                log(`&nbsp;&nbsp;&nbsp;üíé STV 6-Stack Transition`);
                units.forEach(a => { if (checkC(a, "STV Energy Share", "+20")) a.energy += 20; });
            }
        });

        let ord = [...units].sort((a,b) => b.spd - a.spd);
        ord.forEach(u => {
            let sealed = u.cc.seal > 0;
            log(`--- ${u.name} Moves (Nrg: ${u.energy}, Dodge: ${Math.round(u.dodge*100)}%) ---`);

            if (u.cc.fear > 0 || u.cc.silence > 0 || u.cc.seal > 0) {
                log(`&nbsp;&nbsp;&nbsp;‚ö†Ô∏è CC ACTIVE: ${u.cc.fear>0?'FEAR ':''}${u.cc.silence>0?'SILENCE ':''}${u.cc.seal>0?'SEAL':''}`, "#ef4444");
            }

            if (u.name === "BDSM" && u.energy >= 100 && !u.bDone && !sealed) {
                log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è BDSM Threshold: Backline CI Buff`);
                units.forEach(t => { if (!t.isFr) checkC(t, "BDSM Threshold CI"); });
                u.bDone = true;
            }

            let didHitBoss = false;
            let usedBasic = false;

            if (u.energy >= 100 && u.cc.silence <= 0) {
                // ‚îÄ‚îÄ ACTIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                u.energy = 0; u.trans += 6; u.acts++; didHitBoss = true;
                log(`üî• ACTION: Active`);

                units.forEach(target => {
                    if (target.name === "BDSM" && u.name !== "BDSM" && !target.cc.seal)
                        if (checkC(target, "BDSM Passive Energy", "+3")) target.energy += 3;
                });
                if (u.name === "STV") units.forEach(a => { checkC(a,"STV ATK"); checkC(a,"STV Armor"); checkC(a,"STV DR"); checkC(a,"STV CI"); checkC(a,"STV Speed"); });
                if (u.name === "BDSM") {
                    units.forEach(a => { for (let i=0;i<5;i++) checkC(a,"BDSM Active CI"); });
                    if (Math.random() < 0.4) units.forEach(a => { if (checkC(a,"BDSM Active Team Energy","+10")) a.energy += 10; });
                }
                if (u.name === "FQV") units.forEach(a => checkC(a,"FQV Armor Buff"));
                if (u.name === "LBRM") { u.energy += 50; log(`&nbsp;&nbsp;&nbsp;‚ö° LBRM Active: +50 self (direct)`, "#4ade80"); }
                if (u.name === "LFA") checkC(u, "LFA Active ATK Buff");
                if (!sealed && u.art === "Demon Bell") {
                    units.forEach(a => {
                        if (checkC(a,"DB Energy","+20")) a.energy += 20;
                        if (Math.random() < 0.5) { if (checkC(a,"DB Bonus","+10")) a.energy += 10; }
                        checkC(a,"DB Speed Buff");
                    });
                }
                tryStarSoul(u);
                triggerPupil(u);
                triggerNova(u);

            } else if (u.cc.fear <= 0) {
                // ‚îÄ‚îÄ BASIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                u.energy += 50; didHitBoss = true; usedBasic = true;
                log(`‚öîÔ∏è ACTION: Basic Attack`);
                log(`&nbsp;&nbsp;&nbsp;‚ö° Basic Attack self energy: +50 (direct)`, "#4ade80");

                if (u.name === "STV" && !sealed) units.forEach(a => { if (a.isFr) { checkC(a,"STV Front DR"); checkC(a,"STV Front CI"); } else checkC(a,"STV Back ATK"); });
                if (u.name === "SQH" && !sealed) { checkC(u,"SQH Self Crit"); checkC(u,"SQH Self CD"); }
                if (u.name === "LFA" && !sealed) checkC(u,"LFA Self Crit");
                if (u.name === "BDSM" && !sealed && Math.random() < 0.5) { if (checkC(u,"BDSM Basic Energy","+20")) u.energy += 20; }

                tryStarSoul(u);
                triggerPupil(u);
                triggerNova(u);

            } else {
                u.turnsLost++;
                log(`üö´ ACTION: SKIPPED (Fear)`, "#ef4444");
            }

            // 12-stack transitions (before boss counterattack)
            if (u.trans >= 12 && !sealed) {
                u.trans -= 12;
                log(`&nbsp;&nbsp;&nbsp;üíé 12-Stack Transition`);
                units.forEach(a => {
                    if (u.name === "SQH" && a !== u) { checkC(a,"SQH ATK"); if (checkC(a,"SQH Energy","+20")) a.energy += 20; checkC(a,"SQH DR"); }
                    if (u.name === "BDSM") { if (checkC(a,"BDSM Energy Share","+20")) a.energy += 20; }
                    if (u.name === "STV")  { if (checkC(a,"STV 12-Stack Energy","+20")) a.energy += 20; }
                });
            }

            // Foresight / Destiny imprint (basic attacks only, after all hero skills)
            if (usedBasic) {
                if (imp === "foresight") {
                    u.energy += 50;
                    log(`&nbsp;&nbsp;&nbsp;‚ö° [FORESIGHT] ${u.name} +50 extra (direct)`, "#4ade80");
                }
                if (imp === "destiny") {
                    log(`&nbsp;&nbsp;&nbsp;‚ö° [DESTINY] Triggering for all allies`, "#38bdf8");
                    units.forEach(a => {
                        if (Math.random() < 0.75) { if (checkC(a,"Destiny +20","+20")) a.energy += 20; }
                        if (Math.random() < 0.50) { if (checkC(a,"Destiny +20 bonus","+20")) a.energy += 20; }
                    });
                }
            }

            // BOSS COUNTERATTACK ‚Äî Corrupting Touch (after all hero skills complete)
            if (didHitBoss) {
                log(`&nbsp;&nbsp;&nbsp;‚ò†Ô∏è [BOSS COUNTER] Corrupting Touch triggered!`, "#ef4444");
                units.forEach(h => {
                    h.calamity++;
                    log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ò†Ô∏è ‚Üí ${h.name} +1 Calamity (now ${h.calamity})`, "#ef4444");
                    trigCal(h);
                    if (Math.random() < 0.5) { h.curse++; log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ò†Ô∏è ‚Üí ${h.name} +1 Curse (50%)`, "#ef4444"); }
                });
            }
        }); // end ord.forEach

        // ‚îÄ‚îÄ END-OF-TURN CALAMITY CHECK (once per hero after all actions this round) ‚îÄ‚îÄ
        log(`&nbsp;&nbsp;&nbsp;üî• END-OF-TURN CALAMITY CHECK`, "#ef4444");
        units.forEach(u => {
            log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üí ${u.name} Calamity: ${u.calamity}`, "#ef4444");
            trigCal(u);
        });

        // ‚îÄ‚îÄ END-OF-ROUND PHASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Find Pupil wearers for dodge-energy tracking
        let pupilUnits = units.filter(u => u.hasPupil);

        log(`&nbsp;&nbsp;&nbsp;‚òÑÔ∏è BOSS ACTIVE PHASE (Cal +2 All, Curse +2 All ‚Äî Dodge applies)`, "#ef4444");
        units.forEach(u => {
            // Determine effective dodge: Pupil burst grants 100% if active
            let effectiveDodge = (u.pupilDodgeRounds > 0) ? 1.0 : u.dodge;
            if (u.pupilDodgeRounds > 0) {
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üëÅÔ∏è ${u.name} has Pupil 100% dodge active (${u.pupilDodgeRounds} rounds left)`, "#e879f9");
            }

            let dodged = Math.random() < effectiveDodge;
            if (dodged) {
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üí® ${u.name} DODGED the boss active! (no Calamity/Curse)`, "#a3e635");

                // Effect 3: Pupil wearer gets +10 energy for each ally dodge
                pupilUnits.forEach(pw => {
                    pw.energy += 10;
                    log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üëÅÔ∏è [PUPIL] ${pw.name} +10 Energy (ally ${u.name} dodged)`, "#e879f9");
                });
            } else {
                u.curse += 2;
                u.calamity += 2;
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üí ${u.name} +2 Curse & +2 Calamity`, "#ef4444");
                trigCal(u);

                // +10 energy for being hit by boss active
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ö° ${u.name} hit by boss active: +10 Energy`, "#38bdf8");
                if (checkC(u, "Boss Active Hit Energy", "+10")) u.energy += 10;

                // +10 specter bonus to ALL heroes when hit, gated on specter wearer not being sealed
                let specterWearer = units.find(s => s.hasS);
                if (specterWearer && specterWearer.cc.seal <= 0) {
                    log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üîÆ ${u.name} Specter bonus: +10 Energy (boss hit)`, "#f472b6");
                    if (checkC(u, "Boss Active Hit Specter Bonus", "+10")) u.energy += 10;
                }
            }
            for (let k in u.cc) if (u.cc[k] > 0) u.cc[k]--;
        });

        log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è END-OF-ROUND CC CLEANSE`, "#a78bfa");
        const ccTypes = ["silence","fear","seal"];
        units.forEach(u => {
            let activeCC = ccTypes.filter(t => u.cc[t] > 0);
            if (activeCC.length > 0) {
                let pick = activeCC[Math.floor(Math.random() * activeCC.length)];
                u.cc[pick] = 0;
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${u.name} removes ${pick.toUpperCase()}`, "#a78bfa");
            } else {
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${u.name} has no CC to remove`, "#a78bfa");
            }
        });

        log(`&nbsp;&nbsp;&nbsp;ü™û ARTIFACT END-OF-ROUND PHASE`, "#38bdf8");
        units.forEach(u => {
            if (u.cc.seal > 0) return;
            if (u.art === "Mirror") {
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ü™û Mirror Trigger on ${u.name}`);
                units.forEach(a => { if (checkC(a,"Mirror Energy","+15")) a.energy += 15; checkC(a,"Mirror DR"); });
            }
            if (u.art === "Scissors") {
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚úÇÔ∏è Scissors Trigger on ${u.name}`);
                units.forEach(a => { checkC(a,"Scissors ATK Buff (all allies)"); checkC(a,"Scissors HD Buff (all allies)"); });
            }
        });

        log(`&nbsp;&nbsp;&nbsp;üåÄ ELY END-OF-ROUND SPEED BUFF`, "#38bdf8");
        units.forEach(u => {
            if (u.name === "ELY" && u.cc.seal <= 0) {
                let eligible = units.filter(a => a !== u);
                let target = eligible[Math.floor(Math.random() * eligible.length)];
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üåÄ ELY grants Speed Buff to ${target.name}`, "#38bdf8");
                checkC(target, "ELY Speed Buff (random ally)");
            }
        });

        log(`&nbsp;&nbsp;&nbsp;‚ö° GLOBAL SURGE PHASE (+50 Energy per hero)`, "#38bdf8");
        units.forEach(u => { if (checkC(u,"Global Surge","+50")) u.energy += 50; });

        // Soul Specter end-of-round pulse (rounds 1‚Äì5)
        if (r <= 5) {
            units.forEach(u => {
                if (u.hasS) {
                    log(`&nbsp;&nbsp;&nbsp;üîÆ SPECTER EoR PULSE (Round ${r}/5): ${u.name}`, "#f472b6");
                    if (checkC(u,"Specter EoR Self","+50")) u.energy += 50;
                    let allies = units.filter(a => a !== u);
                    let randAlly = allies[Math.floor(Math.random() * allies.length)];
                    if (checkC(randAlly,"Specter EoR Ally","+50")) randAlly.energy += 50;
                }
            });
        }

        log(`&nbsp;&nbsp;&nbsp;‚ö° MAX ATK TARGET PUNISHMENT`, "#ef4444");
        let d = units.find(u => u.isM);
        d.energy = Math.max(0, d.energy - 100);
        d.curse += 3;
        log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üí ${d.name} (Max ATK) -100 Energy & +3 Curse`, "#ef4444");

        log(`&nbsp;&nbsp;&nbsp;‚ùÑÔ∏è CALAMITY PURGE (-1 per hero)`, "#a5b4fc");
        units.forEach(u => {
            if (u.calamity > 0) { u.calamity--; log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ùÑÔ∏è ${u.name}: -1 Cal (now ${u.calamity})`, "#a5b4fc"); }
        });

        log(`&nbsp;&nbsp;&nbsp;üëÅÔ∏è PUPIL DODGE RESET (Max ATK hero dodge resets to base)`, "#e879f9");
        units.forEach(u => {
            if (u.dodge !== u.baseDodge) {
                log(`&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;üëÅÔ∏è ${u.name} Dodge reset: ${Math.round(u.dodge*100)}% ‚Üí ${Math.round(u.baseDodge*100)}%`, "#e879f9");
                u.dodge = u.baseDodge;
            }
        });
    }

    return { units, hd: bossHDStacks };
}

function sim(multi) {
    const out = document.getElementById('output'); out.innerHTML = ""; silent = multi;
    if (!multi) {
        runOne();
    } else {
        let stats = {}, totalHD = 0;
        for (let i = 0; i < 30; i++) {
            let res = runOne();
            totalHD += res.hd;
            res.units.forEach(u => {
                if (!stats[u.name]) stats[u.name] = { acts:0, lost:0 };
                stats[u.name].acts += u.acts;
                stats[u.name].lost += u.turnsLost;
            });
        }
        let html = `<h3>AVERAGES (30 FIGHTS)</h3>`;
        html += `<p><b>Avg Boss Holy Damage Stacks (Fear Landed):</b> <span style="color:var(--accent)">${(totalHD/30).toFixed(2)}</span></p>`;
        html += `<table><tr><th>Hero</th><th>Avg Actives</th><th>Avg Turns Lost (CC)</th></tr>`;
        for (let n in stats) {
            html += `<tr><td>${n}</td><td>${(stats[n].acts/30).toFixed(2)}</td><td>${(stats[n].lost/30).toFixed(2)}</td></tr>`;
        }
        out.innerHTML = html + `</table>`;
    }
}
</script>
</body>
</html>
