<!DOCTYPE html>
<html>
<head>
    <title>Curse of Decay Simulator</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f1a; color: #e0e0e0; padding: 20px; font-size: 14px; }
        .setup { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #161b33; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #2f3542; }
        .imprint-setup { background: #1a1a2e; padding: 15px; border-radius: 8px; border: 2px solid #eccc68; margin-bottom: 10px; display: flex; gap: 20px; align-items: center; }
        .hero-box { border: 1px solid #474787; padding: 10px; border-radius: 4px; background: #1a1a2e; }
        .log { background: #000; border: 2px solid #474787; padding: 15px; height: 800px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; color: #f1f2f6; line-height: 1.5; margin-bottom: 20px;}
        .summary-card { background: #161b33; padding: 20px; border-radius: 8px; border: 2px solid #2ed573; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .summary-table th, .summary-table td { padding: 10px; border: 1px solid #2f3542; text-align: left; }
        .summary-table th { background: #2f3542; color: #2ed573; }
        .round-head { color: #ff4757; border-bottom: 2px solid #ff4757; margin-top: 25px; font-weight: bold; font-size: 1.3em; background: #2d142c; padding: 5px; }
        .phase-name { color: #eccc68; margin-top: 15px; font-weight: bold; text-transform: uppercase; border-left: 4px solid #eccc68; padding-left: 10px; background: #222; }
        .curse-offset { color: #ff7f50; font-style: italic; }
        .buff-gain { color: #2ed573; font-weight: bold; }
        .specter-msg { color: #a55eea; font-weight: bold; }
        .boss-msg { color: #ff4757; font-weight: bold; }
        .island-msg { color: #00d2ff; font-weight: bold; }
        select, button, input { padding: 5px; border-radius: 4px; border: 1px solid #57606f; background: #2f3542; color: white; width: 100%; box-sizing: border-box; }
        button { background: #ff4757; font-weight: bold; cursor: pointer; border: none; font-size: 1.1em; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

    <div class="imprint-setup">
        <strong>Global Settings:</strong>
        <label><input type="radio" name="imprint" value="none" checked> No Imprint</label>
        <label><input type="radio" name="imprint" value="foresight"> Foresight</label>
        <label><input type="radio" name="imprint" value="destiny"> Destiny</label>
        <span style="margin-left: 20px; padding-left: 20px; border-left: 1px solid #444;">
            <label><input type="checkbox" id="island9"> üèùÔ∏è Island 9 (Soul Protection)</label>
        </span>
    </div>

    <div class="setup" id="heroSetup"></div>
    <button onclick="simulate()">Simulate 15-Round Battle</button>
    <div id="log" class="log"></div>
    <div id="summary" class="summary-card" style="display:none;"></div>

<script>
const HERO_LIST = ["LFA", "SQH", "STV", "BDSM", "FQV", "LBRM", "ELY", "HW"];
const ARTIFACTS = ["None", "Demon Bell", "Mirror", "Antlers", "Scissors"];

const setupEl = document.getElementById('heroSetup');
for(let i=1; i<=6; i++) {
    setupEl.innerHTML += `
        <div class="hero-box">
            <strong>Pos ${i}</strong><br>
            Hero: <select id="hero${i}">${HERO_LIST.map(h => `<option value="${h}" ${i===1?'selected':''}>${h}</option>`).join('')}</select>
            Art: <select id="art${i}">${ARTIFACTS.map(a => `<option value="${a}">${a}</option>`).join('')}</select>
            SPD: <input type="number" id="spd${i}" value="${2000 - (i*10)}">
            CI (%): <input type="number" id="ci${i}" value="0">
            Dodge (%): <input type="number" id="dodge${i}" value="0">
            <label><input type="checkbox" id="spec${i}"> Specter</label>
            <label style="font-size:10px; color:#ff4757; display:block;"><input type="radio" name="highestAtk" value="${i}" ${i===1?'checked':''}> Highest ATK</label>
        </div>`;
}

let heroes = [];
let bossHD = 0;
const logEl = document.getElementById('log');
function log(msg, cls = "") { logEl.innerHTML += `<div class="${cls}">${msg}</div>`; }

function checkCurse(hero, type, amount = "") {
    if (hero.curseLayers > 0) {
        hero.curseLayers--;
        log(`&nbsp;&nbsp;&nbsp;‚ú® [CURSE OFFSET] ${hero.name}: ${type} ${amount} (Layers Left: ${hero.curseLayers})`, "curse-offset");
        return false;
    }
    log(`&nbsp;&nbsp;&nbsp;‚úÖ [BUFF GAINED] ${hero.name}: ${type} ${amount}`, "buff-gain");
    return true;
}

function checkCalamityTrigger(hero) {
    if (hero.calamity >= 5) {
        let effectiveCI = hero.baseCI - 1.0; 
        let applyChance = Math.max(0, 1.0 - effectiveCI);
        
        log(`&nbsp;&nbsp;&nbsp;üé≤ ${hero.name} Calamity Check: CI ${(hero.baseCI*100).toFixed(0)}% (Eff ${(effectiveCI*100).toFixed(0)}%), Chance ${(applyChance*100).toFixed(0)}%`);

        if (Math.random() < applyChance) {
            log(`&nbsp;&nbsp;&nbsp;‚ö†Ô∏è <span class="boss-msg">${hero.name} REACHED 5 CALAMITY!</span> Attempting to apply control effects.`, "boss-msg");
            
            // Apply effects if NOT immune via Island 9
            if (hero.immuneTo !== "silence") hero.cc.silence = 2;
            else log(`&nbsp;&nbsp;&nbsp;üèùÔ∏è ${hero.name} Island 9: Immune to SILENCE!`, "island-msg");
            
            if (hero.immuneTo !== "fear") hero.cc.fear = 2;
            else log(`&nbsp;&nbsp;&nbsp;üèùÔ∏è ${hero.name} Island 9: Immune to FEAR!`, "island-msg");
            
            if (hero.immuneTo !== "sealOfLight") hero.cc.sealOfLight = 2;
            else log(`&nbsp;&nbsp;&nbsp;üèùÔ∏è ${hero.name} Island 9: Immune to SEAL OF LIGHT!`, "island-msg");
            
        } else {
            log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${hero.name} RESISTED Calamity Control effects!`);
        }
        hero.calamity = 0;
    }
}

function bossGlobalCounter() {
    log(`&nbsp;&nbsp;&nbsp;‚òÑÔ∏è <span class="boss-msg">BOSS GLOBAL COUNTER!</span>`);
    heroes.forEach(h => { 
        h.calamity += 1;
        let curseMsg = "";
        if (Math.random() < 0.50) {
            h.curseLayers += 1;
            curseMsg = " + üíÄ 1 Curse";
        }
        log(`&nbsp;&nbsp;&nbsp;üí• ${h.name} hit: +1 Calamity${curseMsg}`);
        checkCalamityTrigger(h);
    });
}

function triggerStarSoul(hero) {
    if (!hero.hasSpecter || hero.cc.sealOfLight > 0) return;
    let chance = (hero.starSoulStacks >= 3) ? 1.0 : 0.333;
    if (Math.random() < chance) {
        log(`&nbsp;&nbsp;&nbsp;‚ú® <span class="specter-msg">STAR SOUL TRIGGERED!</span>`);
        hero.starSoulStacks = 0; 
        let highestSpdAlly = [...heroes].sort((a, b) => b.spd - a.spd)[0];
        if(checkCurse(highestSpdAlly, "Star Soul Team", "+100")) highestSpdAlly.energy += 100;
        if(checkCurse(hero, "Star Soul Self", "+50")) hero.energy += 50;
    } else {
        hero.starSoulStacks++;
    }
}

function simulate() {
    logEl.innerHTML = "";
    document.getElementById('summary').style.display = "none";
    heroes = []; bossHD = 0;
    const targetPos = parseInt(document.querySelector('input[name="highestAtk"]:checked').value);
    const globalImprint = document.querySelector('input[name="imprint"]:checked').value;
    const isIsland9 = document.getElementById('island9').checked;
    
    const ccTypes = ["silence", "fear", "sealOfLight"];

    for(let i=1; i<=6; i++) {
        let art = document.getElementById(`art${i}`).value;
        let immunity = isIsland9 ? ccTypes[Math.floor(Math.random() * 3)] : "none";
        
        heroes.push({
            pos: i, name: document.getElementById(`hero${i}`).value,
            energy: (["Demon Bell", "Mirror"].includes(art)) ? 100 : 50,
            curseLayers: 0, calamity: 0, 
            baseCI: parseInt(document.getElementById(`ci${i}`).value) / 100,
            dodge: parseInt(document.getElementById(`dodge${i}`).value) / 100,
            cc: { silence: 0, fear: 0, sealOfLight: 0 },
            immuneTo: immunity,
            artifact: art, transition: 0, spd: parseInt(document.getElementById(`spd${i}`).value),
            hasSpecter: document.getElementById(`spec${i}`).checked, starSoulStacks: 0, 
            isHighestAtk: (i === targetPos), isFrontLine: i <= 2, activeCount: 0,
            bdsmCIGiven: false
        });
    }

    if (isIsland9) {
        log("ISLAND 9 ACTIVE: Soul Protections Granted", "phase-name");
        heroes.forEach(h => log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${h.name} is immune to ${h.immuneTo.toUpperCase()} for this fight.`, "island-msg"));
    }

    log("PRE-BATTLE: Specter Start", "phase-name");
    heroes.forEach(h => {
        if (h.hasSpecter) {
            log(`&nbsp;&nbsp;&nbsp;üîÆ ${h.name} Specter Start: +50 Self & Ally`);
            if(checkCurse(h, "Spec Start Self", "+50")) h.energy += 50;
            let randAlly = heroes[Math.floor(Math.random() * 6)];
            if(checkCurse(randAlly, "Spec Start Team", "+50")) randAlly.energy += 50;
        }
    });

    for (let r = 1; r <= 15; r++) {
        log(`ROUND ${r}`, "round-head");
        log("Part 1: Start of Round", "phase-name");
        heroes.forEach(h => {
            if (h.name === "BDSM") h.bdsmCIGiven = false;
            checkCurse(h, "Global Round ATK Buff");
            if (h.name === "STV" && h.transition >= 6 && h.cc.sealOfLight <= 0) {
                log(`&nbsp;&nbsp;&nbsp;üíé STV 6-Stack Transition Triggered`);
                h.transition -= 6;
                heroes.forEach(ally => { if(checkCurse(ally, "STV Energy Share", "+20")) ally.energy += 20; });
            }
        });

        log("Part 2: Attacking Phase", "phase-name");
        let speedOrder = [...heroes].sort((a, b) => b.spd - a.spd);
        speedOrder.forEach(h => {
            log(`--- ${h.name} Moves (Nrg: ${h.energy}) ---`);
            let usedActive = false; let usedBasic = false;
            let isSealed = h.cc.sealOfLight > 0;

            if (h.name === "BDSM" && h.energy >= 100 && !h.bdsmCIGiven && !isSealed) {
                log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è BDSM Energy Threshold: Backline CI Buff`);
                heroes.forEach(a => { if(!a.isFrontLine) checkCurse(a, "BDSM Threshold CI"); });
                h.bdsmCIGiven = true;
            }

            if (h.energy >= 100) {
                if (h.cc.silence > 0) {
                    log(`&nbsp;&nbsp;&nbsp;üö´ ${h.name} is SILENCED! Active skipped.`, "boss-msg");
                } else {
                    log(`üî• ${h.name} uses ACTIVE!`);
                    h.energy = 0; usedActive = true; h.activeCount++;
                    h.transition += 6;
                    heroes.forEach(target => {
                        if (target.name === "BDSM" && h.name !== "BDSM") {
                            if(checkCurse(target, "BDSM Passive Energy", "+3")) target.energy += 3;
                        }
                    });
                    if (h.name === "STV") {
                        heroes.forEach(a => { 
                            checkCurse(a, "STV ATK/Armor/DR/CI/Speed"); 
                        });
                    }
                    if (h.name === "BDSM") {
                        log(`&nbsp;&nbsp;&nbsp;‚ú® BDSM Active: 5x CI Buff to All`);
                        heroes.forEach(a => { for(let i=0; i<5; i++) checkCurse(a, "BDSM Active CI"); });
                        if (Math.random() < 0.40) {
                            heroes.forEach(a => { if (checkCurse(a, "BDSM Active Team Energy", "+10")) a.energy += 10; });
                        }
                    }
                    if (h.name === "FQV") heroes.forEach(a => checkCurse(a, "FQV Armor Buff"));
                    if (h.name === "LBRM") { h.energy += 50; }
                    if (h.name === "LFA") checkCurse(h, "LFA Active ATK Buff");
                }
            } else {
                if (h.cc.fear > 0) {
                    bossHD += 12;
                    log(`&nbsp;&nbsp;&nbsp;üö´ ${h.name} is FEARED! Basic skipped. Boss HD: ${bossHD}%`, "boss-msg");
                } else {
                    log(`‚öîÔ∏è ${h.name} uses Basic Attack.`);
                    usedBasic = true;
                    h.energy += 50; 
                    if (!isSealed) {
                        if (h.name === "STV") {
                            heroes.forEach(a => {
                                if (a.isFrontLine) { checkCurse(a, "STV Basic Front DR/CI"); }
                                else { checkCurse(a, "STV Basic Back ATK"); }
                            });
                        }
                        if (h.name === "SQH") { checkCurse(h, "SQH Crit/CD"); }
                        if (h.name === "LFA") { checkCurse(h, "LFA Crit"); }
                        if (h.name === "BDSM" && Math.random() < 0.50) {
                            if(checkCurse(h, "BDSM Basic Energy", "+20")) h.energy += 20;
                        }
                    }
                }
            }

            if (h.transition >= 12 && !isSealed) {
                h.transition -= 12;
                if (h.name === "SQH") {
                    heroes.forEach(ally => { if(ally !== h) { checkCurse(ally, "SQH Buffs"); if(checkCurse(ally, "SQH Energy", "+20")) ally.energy += 20; }});
                }
                if (h.name === "FQV") {
                    heroes.forEach(ally => { checkCurse(ally, "FQV Buffs"); if(checkCurse(ally, "FQV Energy", "+20")) ally.energy += 20; });
                }
                if (h.name === "BDSM") {
                    heroes.forEach(ally => { if(checkCurse(ally, "BDSM Energy Share", "+20")) ally.energy += 20; });
                }
                if (h.name === "LFA") checkCurse(h, "LFA CI Buff");
            }

            if (h.artifact === "Demon Bell" && usedActive && !isSealed) {
                heroes.forEach(a => { 
                    if(checkCurse(a, "DB Energy", "+20")) a.energy += 20;
                    if(Math.random() < 0.50) if(checkCurse(a, "DB Bonus", "+10")) a.energy += 10;
                });
            }

            triggerStarSoul(h);

            if (globalImprint === "foresight" && !isSealed) {
                if (usedBasic) { if(checkCurse(h, "Foresight Energy", "+50")) h.energy += 50; }
                if (usedActive) { checkCurse(h, "Foresight Buffs"); }
            } else if (globalImprint === "destiny" && !isSealed) {
                if (usedBasic || (h.name === "LBRM" && usedActive)) {
                    heroes.forEach(ally => {
                        if (Math.random() < 0.75) {
                            if(checkCurse(ally, "Destiny Energy", "+20")) ally.energy += 20;
                            if(Math.random() < 0.50) if(checkCurse(ally, "Destiny Bonus", "+20")) ally.energy += 20;
                        }
                    });
                }
            }
            bossGlobalCounter();
        });

        log("Part 3: Boss Active Phase", "phase-name");
        log(`&nbsp;&nbsp;&nbsp;‚òÑÔ∏è <span class="boss-msg">BOSS ACTIVE SKILL</span>`);
        heroes.forEach(h => {
            if (Math.random() < h.dodge) {
                log(`&nbsp;&nbsp;&nbsp;üí® <span class="specter-msg">${h.name} DODGED!</span>`);
            } else {
                h.curseLayers += 2; h.calamity += 2;
                if(checkCurse(h, "Hit by Active", "+10")) h.energy += 10;
                if (h.cc.sealOfLight <= 0) {
                    if(checkCurse(h, "Spec Passive", "+10")) h.energy += 10;
                }
                checkCalamityTrigger(h);
            }
        });

        log("Part 4: End of Round Phase", "phase-name");
        heroes.forEach(h => {
            let activeCCs = [];
            if (h.cc.silence > 0) activeCCs.push('silence');
            if (h.cc.fear > 0) activeCCs.push('fear');
            if (h.cc.sealOfLight > 0) activeCCs.push('sealOfLight');
            if (activeCCs.length > 0) {
                let choice = activeCCs[Math.floor(Math.random() * activeCCs.length)];
                h.cc[choice] = 0;
                log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${h.name} cleared [${choice.toUpperCase()}] via Round-End Cleanup.`);
            }
            if (h.calamity > 0) h.calamity--;
            if (h.cc.silence > 0) h.cc.silence--;
            if (h.cc.fear > 0) h.cc.fear--;
            if (h.cc.sealOfLight > 0) h.cc.sealOfLight--;

            if (h.cc.sealOfLight <= 0) {
                if (h.artifact === "Mirror") {
                    heroes.forEach(a => { if(checkCurse(a, "Mirror Energy", "+15")) a.energy += 15; });
                }
                if (h.hasSpecter && r <= 5) {
                    if(checkCurse(h, "Spec EOR Self", "+50")) h.energy += 50;
                    let randAlly = heroes[Math.floor(Math.random() * 6)];
                    if(checkCurse(randAlly, "Spec EOR Ally", "+50")) randAlly.energy += 50;
                }
                if(checkCurse(h, "Global Surge", "+50")) h.energy += 50;
            }
        });

        let target = heroes.find(h => h.isHighestAtk);
        target.energy = Math.max(0, target.energy - 100); 
        target.curseLayers += 3;
    }

    document.getElementById('summary').style.display = "block";
    let tableHtml = `<h3>Final Summary</h3><table class="summary-table"><tr><th>Pos</th><th>Hero</th><th>Actives</th><th>End Curse/Calamity</th><th>Soul Protection</th></tr>`;
    heroes.forEach(h => { tableHtml += `<tr><td>${h.pos}</td><td><b>${h.name}</b></td><td>${h.activeCount}</td><td>C:${h.curseLayers} / L:${h.calamity}</td><td>${h.immuneTo.toUpperCase()}</td></tr>`; });
    tableHtml += `</table><p><strong>Total Boss Holy Damage: ${bossHD}%</strong></p>`;
    document.getElementById('summary').innerHTML = tableHtml;
}
</script>
</body>
</html>
