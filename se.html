<!DOCTYPE html>
<html>
<head>
    <title>Curse of Decay - Frozen Reference Engine</title>
    <style>
        body { font-family: 'Consolas', monospace; background: #0a0a0c; color: #00d4ff; padding: 20px; font-size: 12px; }
        .setup { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; background: #1a1a24; padding: 15px; border: 1px solid #333; margin-bottom: 10px; }
        .hero-box { border: 1px solid #444; padding: 8px; background: #12121a; }
        .log { background: #000; border: 1px solid #00d4ff; padding: 15px; height: 600px; overflow-y: auto; color: #fff; line-height: 1.5; margin-bottom: 10px; }
        .summary { background: #161b33; border: 2px solid #2ed573; padding: 15px; border-radius: 8px; color: #fff; }
        .round-head { color: #ff4757; font-weight: bold; border-bottom: 2px solid #ff4757; margin-top: 20px; font-size: 1.2em; display: block; }
        .phase-head { color: #eccc68; font-weight: bold; margin-top: 10px; display: block; text-decoration: underline; }
        .curse-log { color: #ffa502; font-style: italic; }
        .buff-log { color: #2ed573; font-weight: bold; }
        .boss-log { color: #ff6b81; }
        select, input, button { background: #000; color: #00d4ff; border: 1px solid #00d4ff; width: 100%; padding: 4px; margin-bottom: 4px; box-sizing: border-box; }
        button { background: #2ed573; color: #000; font-weight: bold; height: 40px; cursor: pointer; margin-top: 10px; border: none; }
        label { font-size: 10px; display: block; }
    </style>
</head>
<body>

<div id="ui" class="setup"></div>
<div class="setup">
    <div class="hero-box">
        <strong>Global Settings</strong>
        <label>Imprint: <select id="globalImprint"><option value="None">None</option><option value="Foresight">Foresight</option><option value="Destiny">Destiny</option></select></label>
        <label><input type="checkbox" id="island9" checked> Island 9 (Soul Protection)</label>
    </div>
</div>
<button onclick="simulate()">EXECUTE FROZEN ENGINE</button>
<div id="log" class="log"></div>
<div id="summary" class="summary" style="display:none;"></div>

<script>
const HEROES = ["LFA", "SQH", "STV", "BDSM", "FQV", "LBRM", "ELY", "HW"];
const ARTS = ["None", "Demon Bell", "Mirror", "Antlers", "Scissors"];

// Default Data based on request
const defaults = [
    { h: "BDSM", a: "Demon Bell", s: 2000, ci: 120 },
    { h: "SQH",  a: "Mirror",     s: 1900, ci: 110 },
    { h: "LFA",  a: "Antlers",    s: 1500, ci: 200 },
    { h: "HW",   a: "Scissors",   s: 1800, ci: 80  },
    { h: "ELY",  a: "Scissors",   s: 1700, ci: 120 },
    { h: "STV",  a: "Scissors",   s: 1600, ci: 200 }
];

const ui = document.getElementById('ui');
for(let i=1; i<=6; i++) {
    const d = defaults[i-1];
    ui.innerHTML += `
        <div class="hero-box">
            POS ${i} | <select id="h${i}">${HEROES.map(h => `<option value="${h}" ${h===d.h?'selected':''}>${h}</option>`).join('')}</select>
            ART: <select id="a${i}">${ARTS.map(a => `<option value="${a}" ${a===d.a?'selected':''}>${a}</option>`).join('')}</select>
            SPD: <input type="number" id="s${i}" value="${d.s}">
            CI%: <input type="number" id="ci${i}" value="${d.ci}">
            DODGE%: <input type="number" id="d${i}" value="0">
            <label><input type="checkbox" id="spec${i}"> Specter</label>
            <label style="color:red;"><input type="radio" name="maxatk" value="${i}" ${i===1?'checked':''}> Max ATK</label>
        </div>`;
}

let units = [];
let totalHolyDmg = 0;

function log(msg, cls = "") {
    const d = document.createElement('div');
    d.className = cls;
    d.innerHTML = msg;
    document.getElementById('log').appendChild(d);
}

function checkCurse(u, label, detail = "") {
    if (u.curse > 0) {
        u.curse--;
        log(`&nbsp;&nbsp;&nbsp;‚ú® [CURSE OFFSET] ${u.name}: ${label} ${detail} (Left: ${u.curse})`, "curse-log");
        return false;
    }
    log(`&nbsp;&nbsp;&nbsp;‚úÖ [BUFF] ${u.name}: ${label} ${detail}`, "buff-log");
    return true;
}

function checkBDSMThreshold() {
    for (let u of units) {
        if (u.name === "BDSM" && u.energy >= 100 && !u.bdsmCIGiven && u.cc.seal <= 0) {
            log(`&nbsp;&nbsp;&nbsp;‚ö° [BDSM] 100+ Energy Met. Buffing Backline CI.`);
            units.forEach(target => { if (!target.isFront) checkCurse(target, "BDSM Threshold CI"); });
            u.bdsmCIGiven = true;
        }
    }
}

function triggerBossCounter() {
    log(`&nbsp;&nbsp;&nbsp;‚òÑÔ∏è Boss Counter (Hits Team)`);
    units.forEach(u => {
        u.calamity++;
        if (Math.random() < 0.5) u.curse++;
        if (u.calamity >= 5) {
            if (Math.random() > (u.baseCI - 1.0)) {
                log(`&nbsp;&nbsp;&nbsp;üí• ${u.name} Calamity Fail!`, "boss-log");
                u.cc.silence = 2; u.cc.fear = 2; u.cc.seal = 2;
            } else { log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${u.name} CI Resist.`); }
            u.calamity = 0;
        }
    });
    checkBDSMThreshold();
}

function simulate() {
    document.getElementById('log').innerHTML = "";
    const summaryDiv = document.getElementById('summary');
    summaryDiv.innerHTML = "<h3>Active Cast Summary</h3>";
    summaryDiv.style.display = "block";
    
    units = []; totalHolyDmg = 0;
    const maxAtkIdx = parseInt(document.querySelector('input[name="maxatk"]:checked').value);
    const imprint = document.getElementById('globalImprint').value;
    const isIsland9 = document.getElementById('island9').checked;
    const ccTypes = ["silence", "fear", "seal"];

    for(let i=1; i<=6; i++) {
        let art = document.getElementById(`a${i}`).value;
        units.push({
            name: document.getElementById(`h${i}`).value,
            energy: (art === "Demon Bell" || art === "Mirror") ? 100 : 50,
            curse: 0, calamity: 0, trans: 0, specPity: 0, activeCount: 0,
            cc: { silence: 0, fear: 0, seal: 0 },
            immuneTo: isIsland9 ? ccTypes[Math.floor(Math.random()*3)] : "none",
            art: art, spd: parseInt(document.getElementById(`s${i}`).value),
            baseCI: parseInt(document.getElementById(`ci${i}`).value) / 100,
            dodge: parseInt(document.getElementById(`d${i}`).value) / 100,
            hasSpec: document.getElementById(`spec${i}`).checked,
            isMax: (i === maxAtkIdx), isFront: (i <= 2), bdsmCIGiven: false
        });
    }

    for (let r = 1; r <= 15; r++) {
        log(`ROUND ${r}`, "round-head");
        units.forEach(u => u.bdsmCIGiven = false);

        // STAGE 1: SOR
        log("STAGE 1: SOR", "phase-head");
        units.forEach(u => {
            if (u.cc.seal <= 0) checkCurse(u, "Round ATK");
            if (u.name === "STV" && u.trans >= 6 && u.cc.seal <= 0) {
                u.trans -= 6;
                units.forEach(a => { if(checkCurse(a, "STV Leak", "+20")) a.energy += 20; });
            }
        });
        checkBDSMThreshold();

        // STAGE 2: TURNS
        log("STAGE 2: ACTION PHASE", "phase-head");
        let order = [...units].sort((a,b) => b.spd - a.spd);
        for(let u of order) {
            log(`- ${u.name} (E:${u.energy}) -`);
            let isSealed = u.cc.seal > 0;
            let acted = false;

            if (u.energy >= 100 && u.cc.silence <= 0) {
                log(`&nbsp;&nbsp;&nbsp;üöÄ ACTIVE`);
                u.energy = 0; u.trans += 6; acted = true; u.activeCount++;
                units.forEach(b => { if(b.name === "BDSM") { if(checkCurse(b, "BDSM Passive", "+3")) b.energy += 3; } });
                
                if (u.name === "STV") units.forEach(a => { ["ATK","ARM","DR","CI","SPD"].forEach(s => checkCurse(a, `STV ${s}`)); });
                if (u.name === "BDSM") {
                    for(let k=0; k<5; k++) units.forEach(a => checkCurse(a, "BDSM CI Stack"));
                    if(Math.random() < 0.4) units.forEach(a => { if(checkCurse(a, "BDSM RNG", "+10")) a.energy += 10; });
                }
                if (u.name === "FQV") units.forEach(a => checkCurse(a, "FQV ARM"));
                if (u.name === "LBRM") u.energy += 50;
                if (u.name === "LFA") checkCurse(u, "LFA Self ATK");
                if (u.art === "Demon Bell" && !isSealed) {
                    units.forEach(a => { 
                        if(checkCurse(a, "DB", "+20")) a.energy += 20; 
                        if(Math.random() < 0.5) { if(checkCurse(a, "DB RNG", "+10")) a.energy += 10; }
                        checkCurse(a, "DB SPD");
                    });
                }
                if (imprint === "Foresight") { checkCurse(u, "Foresight Crit"); checkCurse(u, "Foresight CD"); }
            } else if (u.cc.fear <= 0) {
                log(`&nbsp;&nbsp;&nbsp;‚öîÔ∏è BASIC`);
                u.energy += 50; acted = true;
                if (u.name === "STV" && !isSealed) {
                    units.forEach(a => { if(a.isFront) { checkCurse(a,"STV F-DR"); checkCurse(a,"STV F-CI"); } else { checkCurse(a,"STV B-ATK"); } });
                }
                if (u.name === "SQH" && !isSealed) { checkCurse(u, "SQH Crit"); checkCurse(u, "SQH CD"); }
                if (u.name === "BDSM" && !isSealed && Math.random() < 0.5) { if(checkCurse(u, "BDSM Basic", "+20")) u.energy += 20; }
                if (u.name === "LFA") checkCurse(u, "LFA Self Crit");
                if (imprint === "Foresight" && !isSealed) { if(checkCurse(u, "Foresight Basic", "+50")) u.energy += 50; }
            } else { totalHolyDmg += 12; log(`&nbsp;&nbsp;&nbsp;üö´ FEARED`, "boss-log"); }

            if (acted) {
                checkBDSMThreshold();
                triggerBossCounter();
                if (imprint === "Destiny" && !isSealed) {
                    if (Math.random() < 0.75) {
                        units.forEach(a => { 
                            let gain = (Math.random() < 0.5) ? 40 : 20;
                            if(checkCurse(a, "Destiny", `+${gain}`)) a.energy += gain; 
                        });
                    }
                }
                if (u.hasSpec && !isSealed) {
                    u.specPity++;
                    if (Math.random() < 0.33 || u.specPity >= 4) {
                        u.specPity = 0;
                        if(checkCurse(u, "Spec Self", "+50")) u.energy += 50;
                        let fast = [...units].sort((a,b)=>b.spd-a.spd)[0];
                        if(checkCurse(fast, "Spec Fastest", "+100")) fast.energy += 100;
                    }
                }
            }

            if (u.trans >= 12 && !isSealed) {
                u.trans -= 12;
                if (u.name === "SQH") units.forEach(a => { checkCurse(a, "SQH ATK"); checkCurse(a, "SQH DR"); if(checkCurse(a, "SQH Nrg", "+20")) a.energy += 20; });
                if (u.name === "FQV") units.forEach(a => { checkCurse(a, "FQV ATK"); if(checkCurse(a, "FQV Nrg", "+20")) a.energy += 20; });
                if (u.name === "BDSM") units.forEach(a => { if(checkCurse(a, "BDSM Share", "+20")) a.energy += 20; });
            }
            checkBDSMThreshold();
        }

        // STAGE 3: BOSS ACTIVE
        log("STAGE 3: BOSS ACTIVE", "phase-head");
        units.forEach(u => {
            if (Math.random() < u.dodge) { log(`&nbsp;&nbsp;&nbsp;üí® ${u.name} Dodged`); }
            else {
                u.curse += 2; u.calamity += 2;
                if(checkCurse(u, "Hit Nrg", "+10")) u.energy += 10;
                if (u.calamity >= 5) {
                    if (Math.random() > (u.baseCI - 1.0)) { u.cc.silence = 2; u.cc.fear = 2; u.cc.seal = 2; log(`&nbsp;&nbsp;&nbsp;üí• ${u.name} Calamity!`, "boss-log"); }
                    u.calamity = 0;
                }
            }
        });
        checkBDSMThreshold();

        // STAGE 4: EOR SEQUENCE
        log("STAGE 4: EOR SEQUENCE", "phase-head");
        units.forEach(u => {
            let ccs = []; if(u.cc.silence>0 && u.immuneTo!=="silence") ccs.push("silence"); if(u.cc.fear>0 && u.immuneTo!=="fear") ccs.push("fear"); if(u.cc.seal>0 && u.immuneTo!=="seal") ccs.push("seal");
            if(ccs.length > 0) { u.cc[ccs[Math.floor(Math.random()*ccs.length)]] = 0; log(`&nbsp;&nbsp;&nbsp;üõ°Ô∏è ${u.name} Cleanse`); }
        });
        units.forEach(u => {
            if (u.cc.seal > 0) return;
            if (u.art === "Mirror") units.forEach(a => { if(checkCurse(a, "Mirror", "+15")) a.energy += 15; checkCurse(a, "Mirror DR"); });
            if (u.art === "Antlers") checkCurse(u, "Antlers DR");
            if (u.art === "Scissors") units.forEach(a => { if(a.isFront === u.isFront) { checkCurse(a, "Scissors ATK"); checkCurse(a, "Scissors Holy"); } });
            if (u.name === "ELY") { let rand = units[Math.floor(Math.random()*6)]; checkCurse(rand, "ELY SPD"); }
            if (u.hasSpec && r <= 5) { if(checkCurse(u, "Spec EOR", "+50")) u.energy += 50; let ra = units[Math.floor(Math.random()*6)]; if(checkCurse(ra, "Spec EOR Ally", "+50")) ra.energy += 50; }
        });
        checkBDSMThreshold();
        units.forEach(u => { if(u.cc.seal <= 0) { if(checkCurse(u, "Surge", "+50")) u.energy += 50; } });
        checkBDSMThreshold();

        // STAGE 5: MAINTENANCE
        log("STAGE 5: MAINTENANCE", "phase-head");
        let d = units.find(u => u.isMax); d.energy = Math.max(0, d.energy - 100); d.curse += 3;
        units.forEach(u => { 
            if(u.cc.silence>0) u.cc.silence--; if(u.cc.fear>0) u.cc.fear--; if(u.cc.seal>0) u.cc.seal--; if(u.calamity>0) u.calamity--; 
        });
    }

    units.forEach(u => {
        summaryDiv.innerHTML += `<div><strong>${u.name}:</strong> ${u.activeCount} Actives</div>`;
    });
}
</script>
</body>
</html>
